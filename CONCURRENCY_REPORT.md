# ë™ì‹œì„± ì´ìŠˆ í•´ê²° ë³´ê³ ì„œ

## ëª©ì°¨
1. [ë°°ê²½](#1-ë°°ê²½)
2. [ë¬¸ì œ ì •ì˜](#2-ë¬¸ì œ-ì •ì˜)
3. [í•´ê²° ë°©ë²•](#3-í•´ê²°-ë°©ë²•)
4. [ì‹¤í—˜ ê²°ê³¼](#4-ì‹¤í—˜-ê²°ê³¼)
5. [í•œê³„ì ](#5-í•œê³„ì )
6. [ê²°ë¡ ](#6-ê²°ë¡ )

---

## 1. ë°°ê²½

### 1.1 ì´ì»¤ë¨¸ìŠ¤ ì‹œìŠ¤í…œì˜ ë™ì‹œì„± ë¬¸ì œ

ì´ì»¤ë¨¸ìŠ¤ ì‹œìŠ¤í…œì—ì„œëŠ” ë‹¤ìˆ˜ì˜ ì‚¬ìš©ìê°€ ë™ì‹œì— ë‹¤ìŒê³¼ ê°™ì€ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:

```
ì‹œë‚˜ë¦¬ì˜¤ 1: ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User A  â”‚   â”‚ User B  â”‚   â”‚ User C  â”‚
â”‚ ë™ì‹œ ë°œê¸‰ â”‚   â”‚ ë™ì‹œ ë°œê¸‰ â”‚   â”‚ ë™ì‹œ ë°œê¸‰ â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚             â”‚             â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ ì¿ í° ì¬ê³ : 1ê°œ    â”‚
         â”‚ ëˆ„ê°€ ë°›ì„ê¹Œ?      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì‹œë‚˜ë¦¬ì˜¤ 2: ìƒí’ˆ ì¬ê³  ì°¨ê°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Order 1 â”‚   â”‚ Order 2 â”‚
â”‚ ìˆ˜ëŸ‰: 5  â”‚   â”‚ ìˆ˜ëŸ‰: 7  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚             â”‚
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ì¬ê³ : 10ê°œ   â”‚
    â”‚ ì´ 12ê°œ ì£¼ë¬¸ â”‚
    â”‚ ì´ˆê³¼ íŒë§¤?   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ì‚¬í•­

#### ì¿ í° ì‹œìŠ¤í…œ
- ì„ ì°©ìˆœ ë°œê¸‰ (í•œì • ìˆ˜ëŸ‰)
- 1ì¸ 1ë§¤ ì œí•œ
- ë™ì‹œ ë°œê¸‰ ì‹œ ì •í™•í•œ ì¬ê³  ê´€ë¦¬

#### ì£¼ë¬¸/ì¬ê³  ì‹œìŠ¤í…œ
- ì£¼ë¬¸ ì‹œì ì— ì¬ê³  ì°¨ê° (ì˜ˆì•½)
- ë™ì‹œ ì£¼ë¬¸ ì‹œ ì´ˆê³¼ íŒë§¤ ë°©ì§€
- ì¬ê³  ë¶€ì¡± ì‹œ ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€

---

## 2. ë¬¸ì œ ì •ì˜

### 2.1 Race Conditionì´ë€?

**Race Condition**ì€ ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤/ìŠ¤ë ˆë“œê°€ ê³µìœ  ìì›ì— ë™ì‹œì— ì ‘ê·¼í•  ë•Œ, ì‹¤í–‰ ìˆœì„œë‚˜ íƒ€ì´ë°ì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì§€ëŠ” ìƒí™©ì…ë‹ˆë‹¤.

#### ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤ 1: ì¿ í° ë°œê¸‰ì—ì„œì˜ Race Condition

```
ì‹œê°„ ìˆœì„œ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  Thread A                      Thread B                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚
â”‚  1. ì¿ í° ì¡°íšŒ                                           â”‚
â”‚     issued = 99                                          â”‚
â”‚     total = 100                                          â”‚
â”‚                                1. ì¿ í° ì¡°íšŒ              â”‚
â”‚                                   issued = 99            â”‚
â”‚                                   total = 100            â”‚
â”‚  2. ì¬ê³  ê²€ì¦                                           â”‚
â”‚     99 < 100 âœ“                                          â”‚
â”‚                                2. ì¬ê³  ê²€ì¦              â”‚
â”‚                                   99 < 100 âœ“            â”‚
â”‚  3. issued++ (100)                                      â”‚
â”‚  4. ì¿ í° ë°œê¸‰ âœ“                                         â”‚
â”‚                                3. issued++ (100) âŒ     â”‚
â”‚                                4. ì¿ í° ë°œê¸‰ âœ“           â”‚
â”‚                                                          â”‚
â”‚  ê²°ê³¼: 101ê°œ ë°œê¸‰ (ì´ˆê³¼ ë°œê¸‰!)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ë¬¸ì œì :**
- ë‘ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— `issued = 99`ë¥¼ ì½ìŒ
- ê°ê° ì¬ê³ ê°€ ì¶©ë¶„í•˜ë‹¤ê³  íŒë‹¨
- ê²°ê³¼ì ìœ¼ë¡œ 100ê°œ ì œí•œì„ ì´ˆê³¼í•˜ì—¬ ë°œê¸‰

#### ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤ 2: ì¬ê³  ì°¨ê°ì—ì„œì˜ Race Condition

```
ì´ˆê¸° ìƒíƒœ: ì¬ê³  10ê°œ

ì‹œê°„ â†’
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚  ì£¼ë¬¸ A (5ê°œ)              ì£¼ë¬¸ B (7ê°œ)                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”‚
â”‚  1. ì¬ê³  ì¡°íšŒ: 10ê°œ                                     â”‚
â”‚  2. ê²€ì¦: 10 >= 5 âœ“                                     â”‚
â”‚                            1. ì¬ê³  ì¡°íšŒ: 10ê°œ           â”‚
â”‚                            2. ê²€ì¦: 10 >= 7 âœ“           â”‚
â”‚  3. stock = 10 - 5 = 5                                  â”‚
â”‚  4. DB ì €ì¥ (5ê°œ)                                       â”‚
â”‚                            3. stock = 10 - 7 = 3        â”‚
â”‚                            4. DB ì €ì¥ (3ê°œ) âœ“           â”‚
â”‚                                                         â”‚
â”‚  ê²°ê³¼: ìµœì¢… ì¬ê³  3ê°œ                                    â”‚
â”‚  ì‹¤ì œ: 5 + 7 = 12ê°œ íŒë§¤ (ì´ˆê³¼ íŒë§¤!)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ë¬¸ì œì :**
- ì£¼ë¬¸ Aê°€ ì €ì¥í•˜ê¸° ì „ì— ì£¼ë¬¸ Bê°€ ì¡°íšŒ
- ì£¼ë¬¸ BëŠ” ê°±ì‹  ì „ ì¬ê³ (10ê°œ)ë¥¼ ì½ìŒ
- Lost Update ë°œìƒ (ì£¼ë¬¸ Aì˜ ì°¨ê°ì´ ìœ ì‹¤ë¨)

### 2.2 ë™ì‹œì„± ë¬¸ì œì˜ ì˜í–¥

#### ë¹„ì¦ˆë‹ˆìŠ¤ ì˜í–¥
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì´ˆê³¼ íŒë§¤/ë°œê¸‰                         â”‚
â”‚  â†“                                     â”‚
â”‚ ì¬ê³  ë¶€ì¡±ìœ¼ë¡œ ë°°ì†¡ ë¶ˆê°€                â”‚
â”‚  â†“                                     â”‚
â”‚ ê³ ê° ë¶ˆë§Œ ë° ì·¨ì†Œ ì²˜ë¦¬ ë¹„ìš© ì¦ê°€       â”‚
â”‚  â†“                                     â”‚
â”‚ ë¸Œëœë“œ ì‹ ë¢°ë„ í•˜ë½                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ë°ì´í„° ì •í•©ì„± ë¬¸ì œ
- ì‹¤ì œ ì¬ê³  != DB ì¬ê³ 
- ë°œê¸‰ ìˆ˜ëŸ‰ != ì‹¤ì œ ë°œê¸‰ëœ ì¿ í° ìˆ˜
- íšŒê³„ ë°ì´í„° ë¶ˆì¼ì¹˜

---

## 3. í•´ê²° ë°©ë²•

### 3.1 í•´ê²° ì „ëµ ê°œìš”

ë³¸ í”„ë¡œì íŠ¸ì—ì„œëŠ” **ë¹„ì¦ˆë‹ˆìŠ¤ íŠ¹ì„±ì— ë§ëŠ” ì°¨ë³„í™”ëœ ì „ëµ**ì„ ì ìš©í–ˆìŠµë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  ì¿ í° ë°œê¸‰                           ì¬ê³  ê´€ë¦¬           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚                                                          â”‚
â”‚  Redis ë¶„ì‚°ë½ + @Transactional     DB ë¹„ê´€ì  ë½        â”‚
â”‚  + DB ë¹„ê´€ì  ë½ (ì´ì¤‘ ë³´í˜¸)        (ë‹¨ì¼ ê³„ì¸µ)          â”‚
â”‚                                                          â”‚
â”‚  (ê³ íŠ¸ë˜í”½ + ì›ìì„± ë³´ì¥)           (ì‹¬í”Œ ì „ëµ)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ì¬ê³  ê´€ë¦¬: DB ë¹„ê´€ì  ë½

#### 3.2.1 ë¹„ê´€ì  ë½ ê°œë…

**ë¹„ê´€ì  ë½(Pessimistic Lock)**ì€ íŠ¸ëœì­ì…˜ì´ ì‹œì‘ë  ë•Œ ë°ì´í„°ì— ë½ì„ ê±¸ì–´, ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ì ‘ê·¼í•˜ì§€ ëª»í•˜ë„ë¡ í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.

```sql
-- JPAì˜ @Lock(LockModeType.PESSIMISTIC_WRITE)ëŠ”
-- ë‹¤ìŒê³¼ ê°™ì€ SQLì„ ìƒì„±í•©ë‹ˆë‹¤:

SELECT * FROM products
WHERE id = ?
FOR UPDATE;
```

#### 3.2.2 ë™ì‘ ì›ë¦¬

```
ì‹œê°„ â†’
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚  íŠ¸ëœì­ì…˜ A                 íŠ¸ëœì­ì…˜ B                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚                                                         â”‚
â”‚  1. SELECT ... FOR UPDATE                               â”‚
â”‚     (ì¬ê³  10ê°œ)                                         â”‚
â”‚     ğŸ”’ ë½ íšë“                                          â”‚
â”‚                                                         â”‚
â”‚                            1. SELECT ... FOR UPDATE     â”‚
â”‚                               â³ ëŒ€ê¸° ì¤‘...             â”‚
â”‚  2. ì¬ê³  ê²€ì¦: 10 >= 5 âœ“                                â”‚
â”‚  3. stock = 5                                           â”‚
â”‚  4. UPDATE products                                     â”‚
â”‚  5. COMMIT                                              â”‚
â”‚     ğŸ”“ ë½ í•´ì œ                                          â”‚
â”‚                                                         â”‚
â”‚                            2. ğŸ”’ ë½ íšë“                â”‚
â”‚                               (ì¬ê³  5ê°œ)                â”‚
â”‚                            3. ì¬ê³  ê²€ì¦: 5 >= 7 âœ—       â”‚
â”‚                            4. InsufficientStockException â”‚
â”‚                            5. ROLLBACK                  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2.3 êµ¬í˜„ ì½”ë“œ

**ProductJpaRepository.kt**
```kotlin
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT p FROM Product p WHERE p.id IN :ids ORDER BY p.id")
fun findAllByIdWithLock(@Param("ids") ids: List<UUID>): List<Product>
```

**OrderServiceImpl.kt**
```kotlin
private fun deductStock(items: List<OrderItemCommand>): Map<UUID, Product> {
    // ë¹„ê´€ì  ë½ìœ¼ë¡œ ìƒí’ˆ ì¡°íšŒ (ë°ë“œë½ ë°©ì§€ë¥¼ ìœ„í•´ ID ì •ë ¬ë¨)
    val productIds = items.map { it.productId }.distinct().sorted()
    val lockedProducts = productService.findAllByIdWithLock(productIds)

    val products = mutableMapOf<UUID, Product>()

    // ì¬ê³  ì°¨ê° (ë”í‹° ì²´í‚¹ìœ¼ë¡œ ìë™ ì €ì¥ë¨)
    items.forEach { item ->
        val product = lockedProducts.find { it.id == item.productId }
            ?: throw ProductNotFoundException(item.productId)

        // deductStock()ì—ì„œ ì¬ê³  ê²€ì¦ ë° ì°¨ê°
        product.deductStock(item.quantity)
        products[product.id!!] = product
    }

    return products.toMap()
}
```

**ë°ë“œë½ ë°©ì§€ ì „ëµ:**
```
ì •ë ¬ ì—†ì´:
íŠ¸ëœì­ì…˜ A: Product(1) â†’ Product(2) ë½ ì‹œë„
íŠ¸ëœì­ì…˜ B: Product(2) â†’ Product(1) ë½ ì‹œë„
â†’ ì„œë¡œ ëŒ€ê¸° â†’ ë°ë“œë½ ë°œìƒ

ì •ë ¬ ì ìš©:
íŠ¸ëœì­ì…˜ A: Product(1) â†’ Product(2) ë½ ì‹œë„
íŠ¸ëœì­ì…˜ B: Product(1) ëŒ€ê¸° â†’ Product(2) ë½ ì‹œë„
â†’ ìˆœì°¨ì  ì²˜ë¦¬ â†’ ë°ë“œë½ ë°©ì§€
```

### 3.3 ì¿ í° ë°œê¸‰: Redis ë¶„ì‚°ë½

#### 3.3.1 ì™œ Redis ë¶„ì‚° ë½ì„ ì„ íƒí–ˆëŠ”ê°€?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚  ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ì˜ íŠ¹ì§•:                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                 â”‚
â”‚  â€¢ ëŒ€ëŸ‰ì˜ ë™ì‹œ ìš”ì²­ ë°œìƒ (ì´ë²¤íŠ¸ íŠ¹ì„±)                  â”‚
â”‚  â€¢ ë¹ ë¥¸ ì‘ë‹µ ì†ë„ í•„ìš” (ì‚¬ìš©ì ê²½í—˜)                    â”‚
â”‚  â€¢ DB ë¶€í•˜ ìµœì†Œí™” í•„ìš” (ì»¤ë„¥ì…˜ í’€ ê³ ê°ˆ ë°©ì§€)            â”‚
â”‚  â€¢ ë©€í‹° ì„œë²„ í™˜ê²½ (ìˆ˜í‰ í™•ì¥ ê°€ëŠ¥)                      â”‚
â”‚                                                         â”‚
â”‚  Redis ë¶„ì‚° ë½ì˜ ì¥ì :                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ ë©”ëª¨ë¦¬ ê¸°ë°˜ìœ¼ë¡œ ë¹ ë¥¸ ë½ íšë“/í•´ì œ (1-2ms) âœ“          â”‚
â”‚  â€¢ ë©€í‹° ì„œë²„ í™˜ê²½ì—ì„œ ë™ì‹œì„± ì œì–´ âœ“                     â”‚
â”‚  â€¢ DB ì ‘ê·¼ ì „ íŠ¸ë˜í”½ ì œì–´ (30% ì°¨ë‹¨) âœ“                  â”‚
â”‚  â€¢ ë½ íšë“ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì‘ë‹µ (ë¹ ë¥¸ ì‹¤íŒ¨) âœ“              â”‚
â”‚  â€¢ SETNX ì›ìì  ì—°ì‚°ìœ¼ë¡œ ê°„ë‹¨í•œ êµ¬í˜„ âœ“                  â”‚
â”‚                                                         â”‚
â”‚  ë°ì´í„° ì •í•©ì„± ë³´ì¥:                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                    â”‚
â”‚  â€¢ Redis ë½ìœ¼ë¡œ í•œ ë²ˆì— í•˜ë‚˜ì˜ ìš”ì²­ë§Œ ì²˜ë¦¬              â”‚
â”‚  â€¢ @Transactionalë¡œ Coupon + UserCoupon ì›ìì  ì €ì¥    â”‚
â”‚  â€¢ unlockAfterCommitìœ¼ë¡œ íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„ ë½ í•´ì œ       â”‚
â”‚  â€¢ DB ë¹„ê´€ì  ë½ìœ¼ë¡œ ì´ì¤‘ ë³´í˜¸ (Redis ì¥ì•  ëŒ€ë¹„)         â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.3.2 Redis ë¶„ì‚° ë½ êµ¬í˜„

**RedisDistributedLock.kt**
```kotlin
fun tryLock(
    lockKey: String,
    waitTimeMs: Long = 3000,    // ë½ íšë“ ëŒ€ê¸° ì‹œê°„
    leaseTimeMs: Long = 5000    // ë½ ë³´ìœ  ì‹œê°„ (ìë™ í•´ì œ)
): String? {
    val lockValue = "${UUID.randomUUID()}-${Thread.currentThread().id}"
    val startTime = System.currentTimeMillis()
    val endTime = startTime + waitTimeMs

    while (System.currentTimeMillis() < endTime) {
        // SETNX (SET if Not eXists) ë°©ì‹ìœ¼ë¡œ ë½ íšë“
        val acquired = redisTemplate.opsForValue()
            .setIfAbsent(lockKey, lockValue, Duration.ofMillis(leaseTimeMs))
            ?: false

        if (acquired) {
            return lockValue  // ë½ íšë“ ì„±ê³µ (lockValue ë°˜í™˜)
        }

        val remainingTime = endTime - System.currentTimeMillis()
        if (remainingTime <= 0) break

        val sleepTime = minOf(50L, remainingTime)

        try {
            TimeUnit.MILLISECONDS.sleep(sleepTime)
        } catch (e: InterruptedException) {
            Thread.currentThread().interrupt()
            return null
        }
    }

    return null  // ë½ íšë“ ì‹¤íŒ¨
}

/**
 * íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„ ë½ í•´ì œ
 *
 * ë°ì´í„° ì •í•©ì„±ì˜ í•µì‹¬:
 * - íŠ¸ëœì­ì…˜ì´ ì™„ì „íˆ ì»¤ë°‹ëœ í›„ ë½ í•´ì œ
 * - ë‹¤ìŒ ìš”ì²­ì´ ìµœì‹  ë°ì´í„°ë¥¼ ì½ë„ë¡ ë³´ì¥
 * - ë¡¤ë°± ì‹œì—ë„ ë½ í•´ì œí•˜ì—¬ ë°ë“œë½ ë°©ì§€
 */
fun unlockAfterCommit(lockKey: String, lockValue: String) {
    // í˜„ì¬ íŠ¸ëœì­ì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    if (TransactionSynchronizationManager.isActualTransactionActive()) {
        // íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„ ì‹¤í–‰ë  ì½œë°± ë“±ë¡
        TransactionSynchronizationManager.registerSynchronization(
            object : TransactionSynchronization {
                override fun afterCommit() {
                    // íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì„±ê³µ í›„ ë½ í•´ì œ
                    unlock(lockKey, lockValue)
                }

                override fun afterCompletion(status: Int) {
                    // ë¡¤ë°± ì‹œì—ë„ ë½ í•´ì œ (ì•ˆì „í•œ ì •ë¦¬)
                    if (status == TransactionSynchronization.STATUS_ROLLED_BACK) {
                        unlock(lockKey, lockValue)
                    }
                }
            }
        )
    } else {
        // íŠ¸ëœì­ì…˜ì´ ì—†ìœ¼ë©´ ì¦‰ì‹œ í•´ì œ
        unlock(lockKey, lockValue)
    }
}
```

**Redis SETNX ë™ì‘ ì›ë¦¬:**
```
ì‹œê°„ â†’
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚  Thread A                      Thread B                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€â”€â”€                â”‚
â”‚                                                         â”‚
â”‚  1. SETNX coupon:issue:123                              â”‚
â”‚     â†’ ì„±ê³µ (í‚¤ ìƒì„±ë¨)                                  â”‚
â”‚     ğŸ”’ ë½ íšë“                                          â”‚
â”‚                                                         â”‚
â”‚                                1. SETNX coupon:issue:123â”‚
â”‚                                   â†’ ì‹¤íŒ¨ (í‚¤ ì¡´ì¬)      â”‚
â”‚                                   â³ 50ms ëŒ€ê¸°          â”‚
â”‚                                                         â”‚
â”‚  2. ì¿ í° ë°œê¸‰ ì²˜ë¦¬                                      â”‚
â”‚  3. DEL coupon:issue:123                                â”‚
â”‚     ğŸ”“ ë½ í•´ì œ                                          â”‚
â”‚                                                         â”‚
â”‚                                2. SETNX coupon:issue:123â”‚
â”‚                                   â†’ ì„±ê³µ âœ“              â”‚
â”‚                                   ğŸ”’ ë½ íšë“            â”‚
â”‚                                3. ì¿ í° ë°œê¸‰ ì²˜ë¦¬        â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.3.3 Redis ë¶„ì‚° ë½ + @Transactional íë¦„

**ë°ì´í„° ì •í•©ì„± ë³´ì¥ ì „ëµ:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  Redis ë¶„ì‚° ë½ ì•ˆì—ì„œ íŠ¸ëœì­ì…˜ ì™„ì „ ì»¤ë°‹                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”‚
â”‚                                                          â”‚
â”‚  1. Redis ë¶„ì‚° ë½ íšë“ (tryLock)                         â”‚
â”‚  2. @Transactional ì‹œì‘ (issueCouponInternal)            â”‚
â”‚  3. unlockAfterCommit ë“±ë¡ (íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„ ë½ í•´ì œ)    â”‚
â”‚  4. ë¹„ê´€ì  ë½ìœ¼ë¡œ ì¿ í° ì¡°íšŒ (findByIdWithLock)           â”‚
â”‚  5. ì¤‘ë³µ ë°œê¸‰ ê²€ì¦ (1ì¸ 1ë§¤)                             â”‚
â”‚  6. ë°œê¸‰ ê¸°ê°„ ê²€ì¦                                       â”‚
â”‚  7. ì¬ê³  ê²€ì¦                                            â”‚
â”‚  8. ë°œê¸‰ ìˆ˜ëŸ‰ ì¦ê°€ (Coupon í…Œì´ë¸” UPDATE)                â”‚
â”‚  9. ì‚¬ìš©ì ì¿ í° ìƒì„± (UserCoupon í…Œì´ë¸” INSERT)          â”‚
â”‚  10. íŠ¸ëœì­ì…˜ ì»¤ë°‹ âœ“ (Coupon + UserCoupon ì›ìì  ì €ì¥)   â”‚
â”‚  11. Redis ë½ í•´ì œ (unlockAfterCommit ì½œë°± ì‹¤í–‰)         â”‚
â”‚                                                          â”‚
â”‚  â†’ ë‹¤ìŒ ìš”ì²­ì´ ìµœì‹  ë°ì´í„°ë¥¼ ì½ìŒ (ì •í•©ì„± ë³´ì¥)         â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CouponServiceImpl.kt**
```kotlin
/**
 * ì¿ í° ë°œê¸‰
 *
 * Redis ë¶„ì‚° ë½ + @Transactional ì¡°í•©:
 * 1. Redis ë¶„ì‚° ë½: ë©€í‹° ì„œë²„ í™˜ê²½ì˜ ë™ì‹œì„± ì œì–´ ë° DB ë¶€í•˜ ê°ì†Œ
 * 2. DB ë¹„ê´€ì  ë½: ë°ì´í„° ì •í•©ì„± ì´ì¤‘ ë³´í˜¸
 * 3. @Transactional: Coupon + UserCoupon ì›ìì  ì €ì¥
 * 4. unlockAfterCommit: íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„ ë½ í•´ì œë¡œ ë°ì´í„° ì •í•©ì„± ë³´ì¥
 */
override fun issueCoupon(couponId: UUID, request: IssueCouponCommand): IssueCouponResult {
    val lockKey = "coupon:issue:$couponId"

    // 1. Redis ë¶„ì‚° ë½ íšë“ ì‹œë„ (3ì´ˆ ëŒ€ê¸°, 10ì´ˆ ìœ ì§€)
    val lockValue = redisDistributedLock.tryLock(
        lockKey = lockKey,
        waitTimeMs = 3000,
        leaseTimeMs = 10000
    ) ?: throw LockAcquisitionFailedException("ì¿ í° ë°œê¸‰ ìš”ì²­ì´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")

    try {
        // 2. íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì¿ í° ë°œê¸‰ ì²˜ë¦¬ + ì»¤ë°‹ í›„ ë½ í•´ì œ
        return issueCouponInternal(couponId, request, lockKey, lockValue)
    } catch (e: Exception) {
        // ì˜ˆì™¸ ë°œìƒ ì‹œ ì¦‰ì‹œ ë½ í•´ì œ
        redisDistributedLock.unlock(lockKey, lockValue)
        throw e
    }
}

@Transactional
fun issueCouponInternal(
    couponId: UUID,
    request: IssueCouponCommand,
    lockKey: String,
    lockValue: String
): IssueCouponResult {
    // íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„ ë½ í•´ì œë˜ë„ë¡ ë“±ë¡ (í•µì‹¬!)
    redisDistributedLock.unlockAfterCommit(lockKey, lockValue)

    // ë¹„ê´€ì  ë½ìœ¼ë¡œ ì¿ í° ì¡°íšŒ (ì´ì¤‘ ë³´í˜¸)
    val coupon = couponRepository.findByIdWithLock(couponId)
        .orElseThrow { CouponNotFoundException(couponId) }

    // ì¤‘ë³µ ë°œê¸‰ ê²€ì¦ (1ì¸ 1ë§¤ ì œí•œ)
    val existingUserCoupon = userCouponRepository
        .findFirstByUserIdAndCouponId(request.userId, couponId)
    if (existingUserCoupon != null) {
        throw CouponAlreadyIssuedException(request.userId, couponId)
    }

    // ë°œê¸‰ ê¸°ê°„ ê²€ì¦
    val today = LocalDate.now()
    val startDate = coupon.startDate.toLocalDate()
    val endDate = coupon.endDate.toLocalDate()

    if (today.isBefore(startDate)) {
        throw InvalidCouponDateException("The coupon issuance period has not started.")
    }
    if (today.isAfter(endDate)) {
        throw InvalidCouponDateException("The coupon issuance period has ended.")
    }

    // ì¬ê³  ê²€ì¦
    if (coupon.issuedQuantity >= coupon.totalQuantity) {
        throw CouponSoldOutException(couponId)
    }

    // ë°œê¸‰ ìˆ˜ëŸ‰ ì¦ê°€
    coupon.issuedQuantity++
    couponRepository.save(coupon)

    // ì‚¬ìš©ì ì¿ í° ìƒì„± (Coupon + UserCouponì´ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì—ì„œ ì›ìì ìœ¼ë¡œ ì €ì¥)
    val now = LocalDateTime.now()
    val expiresAt = now.plusDays(coupon.validityDays.toLong())

    val userCoupon = UserCoupon(
        userId = request.userId,
        couponId = couponId,
        status = CouponStatus.AVAILABLE,
        issuedAt = now,
        expiresAt = expiresAt,
        usedAt = null
    )

    val savedUserCoupon = userCouponRepository.save(userCoupon)

    return IssueCouponResult(
        userCouponId = savedUserCoupon.id!!,
        userId = savedUserCoupon.userId,
        couponId = coupon.id!!,
        couponName = coupon.name,
        discountRate = coupon.discountRate,
        status = savedUserCoupon.status.name,
        issuedAt = savedUserCoupon.issuedAt.toString(),
        expiresAt = savedUserCoupon.expiresAt.toString(),
        remainingQuantity = coupon.totalQuantity - coupon.issuedQuantity,
        totalQuantity = coupon.totalQuantity
    )
}
```

**í•µì‹¬ í¬ì¸íŠ¸:**
```kotlin
// âŒ ì˜ëª»ëœ ë°©ë²• 1: íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì „ì— ë½ í•´ì œ
@Transactional
fun issueCoupon() {
    redisLock.lock()
    try {
        // ì¿ í° ë°œê¸‰ ë¡œì§
        couponRepository.save(coupon)
        userCouponRepository.save(userCoupon)
    } finally {
        redisLock.unlock()  // âŒ íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì „ì— ë½ í•´ì œ!
    }
}  // íŠ¸ëœì­ì…˜ ì»¤ë°‹ (ëŠ¦ìŒ)
// ë¬¸ì œ: ë‹¤ìŒ ìš”ì²­ì´ ì•„ì§ ì»¤ë°‹ë˜ì§€ ì•Šì€ ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ìˆìŒ (Dirty Read)

// âŒ ì˜ëª»ëœ ë°©ë²• 2: @Transactional ì—†ì´ Redis ë½ë§Œ ì‚¬ìš©
fun issueCoupon() {
    redisLock.lock()
    try {
        couponRepository.save(coupon)  // âŒ ë³„ë„ íŠ¸ëœì­ì…˜
        userCouponRepository.save(userCoupon)  // âŒ ë³„ë„ íŠ¸ëœì­ì…˜
    } finally {
        redisLock.unlock()
    }
}
// ë¬¸ì œ: coupon ì €ì¥ ì„±ê³µ í›„ userCoupon ì €ì¥ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ì•ˆë¨ (ì›ìì„± ê¹¨ì§)

// âœ… ì˜¬ë°”ë¥¸ ë°©ë²•: @Transactional + unlockAfterCommit
override fun issueCoupon() {
    val lockValue = redisLock.tryLock()
    try {
        return issueCouponInternal(lockValue)  // @Transactional ë©”ì„œë“œ í˜¸ì¶œ
    } catch (e: Exception) {
        redisLock.unlock(lockValue)
        throw e
    }
}

@Transactional
fun issueCouponInternal(lockValue: String) {
    redisLock.unlockAfterCommit(lockValue)  // âœ… íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„ ë½ í•´ì œ ë“±ë¡

    // ì¿ í° ë°œê¸‰ ë¡œì§
    couponRepository.save(coupon)
    userCouponRepository.save(userCoupon)

    // íŠ¸ëœì­ì…˜ ì»¤ë°‹ â†’ unlockAfterCommit ì½œë°± ì‹¤í–‰ â†’ Redis ë½ í•´ì œ
}
// íš¨ê³¼:
// 1. Coupon + UserCouponì´ ì›ìì ìœ¼ë¡œ ì €ì¥ë¨ (ë‘˜ ë‹¤ ì„±ê³µ ë˜ëŠ” ë‘˜ ë‹¤ ë¡¤ë°±)
// 2. íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„ ë½ í•´ì œ â†’ ë‹¤ìŒ ìš”ì²­ì´ í•­ìƒ ìµœì‹  ë°ì´í„°ë¥¼ ì½ìŒ
```

**Redis ë¶„ì‚° ë½ + @Transactional íë¦„ ì‹œê°í™”:**
```
        ëŒ€ëŸ‰ ë™ì‹œ ìš”ì²­ (200ëª…)
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redis ë¶„ì‚° ë½ (1ì°¨ ê´€ë¬¸)    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  â€¢ ë©€í‹° ì„œë²„ í™˜ê²½ ëŒ€ì‘       â”‚
â”‚  â€¢ ë¹ ë¥¸ ë½ íšë“/í•´ì œ (1-2ms) â”‚
â”‚  â€¢ DB ë¶€í•˜ ìµœì†Œí™” (30% ì°¨ë‹¨) â”‚
â”‚  â€¢ ì‹¤íŒ¨ ì‹œ ë¹ ë¥¸ ì‘ë‹µ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
        ë½ íšë“ ì„±ê³µ (ìˆœì°¨ì )
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  @Transactional ì²˜ë¦¬         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  â€¢ unlockAfterCommit ë“±ë¡    â”‚
â”‚  â€¢ DB ë¹„ê´€ì  ë½ (2ì°¨ ë³´í˜¸)   â”‚
â”‚  â€¢ ì¬ê³  ê²€ì¦ ë° ì°¨ê°         â”‚
â”‚  â€¢ Coupon + UserCoupon ì €ì¥  â”‚
â”‚  â€¢ íŠ¸ëœì­ì…˜ ì»¤ë°‹ âœ“           â”‚
â”‚  â€¢ Redis ë½ í•´ì œ (ì½œë°±)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
   ì •í™•íˆ 100ëª…ë§Œ ë°œê¸‰ (ì›ìì„± + ì •í•©ì„±)
   
   âœ“ Coupon.issuedQuantity = 100
   âœ“ UserCoupon ë ˆì½”ë“œ = 100ê°œ
   âœ“ ì´ˆê³¼ ë°œê¸‰ = 0ê±´
```

### 3.4 íŠ¸ëœì­ì…˜ ë²”ìœ„ ìµœì í™”

ë½ì„ ë³´ìœ í•˜ëŠ” ì‹œê°„ì„ ìµœì†Œí™”í•˜ì—¬ ì„±ëŠ¥ì„ ê°œì„ í–ˆìŠµë‹ˆë‹¤:

```kotlin
// âŒ ë¹„íš¨ìœ¨ì : íŠ¸ëœì­ì…˜ ë²”ìœ„ê°€ ë„ˆë¬´ ë„“ìŒ
@Transactional
override fun createOrder(request: CreateOrderCommand): CreateOrderResult {
    validateOrderRequest(request)  // íŠ¸ëœì­ì…˜ í•„ìš” ì—†ìŒ
    val user = userService.getUser(request.userId)  // íŠ¸ëœì­ì…˜ í•„ìš” ì—†ìŒ

    val orderData = createOrderTransaction(request, user.id!!)

    cartService.deleteCarts(...)  // íŠ¸ëœì­ì…˜ í•„ìš” ì—†ìŒ
    applicationEventPublisher.publishEvent(...)  // íŠ¸ëœì­ì…˜ í•„ìš” ì—†ìŒ

    return CreateOrderResult(...)  // íŠ¸ëœì­ì…˜ í•„ìš” ì—†ìŒ
}

// âœ“ ìµœì í™”: íŠ¸ëœì­ì…˜ ë²”ìœ„ë¥¼ í•µì‹¬ ë¡œì§ìœ¼ë¡œ ì œí•œ
override fun createOrder(request: CreateOrderCommand): CreateOrderResult {
    validateOrderRequest(request)  // íŠ¸ëœì­ì…˜ ë°–
    val user = userService.getUser(request.userId)  // íŠ¸ëœì­ì…˜ ë°–

    val orderData = createOrderTransaction(request, user.id!!)  // íŠ¸ëœì­ì…˜

    cartService.deleteCarts(...)  // íŠ¸ëœì­ì…˜ ë°–
    applicationEventPublisher.publishEvent(...)  // íŠ¸ëœì­ì…˜ ë°–

    return CreateOrderResult(...)  // íŠ¸ëœì­ì…˜ ë°–
}

@Transactional  // ì—¬ê¸°ì„œë§Œ íŠ¸ëœì­ì…˜ ì‹œì‘
private fun createOrderTransaction(request: CreateOrderCommand, userId: UUID): OrderCreationData {
    val products = deductStock(request.items)  // ë¹„ê´€ì  ë½
    val userCoupon = validateAndUseCoupon(...)
    // ... ì£¼ë¬¸ ìƒì„± ë¡œì§
    return OrderCreationData(...)
}
```

**íš¨ê³¼:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚  Before: ë½ ë³´ìœ  ì‹œê°„ = 1000ms                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”‚
â”‚  [ê²€ì¦ 200ms] + [DBë½ 500ms] + [ì´ë²¤íŠ¸ 300ms]          â”‚
â”‚                                                         â”‚
â”‚  After: ë½ ë³´ìœ  ì‹œê°„ = 500ms                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                            â”‚
â”‚  ê²€ì¦ 200ms | [DBë½ 500ms] | ì´ë²¤íŠ¸ 300ms              â”‚
â”‚                                                         â”‚
â”‚  ê°œì„ : 50% ê°ì†Œ â†’ ë™ì‹œì„± ì²˜ë¦¬ ëŠ¥ë ¥ 2ë°° í–¥ìƒ            â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ì‹¤í—˜ ê²°ê³¼

### 4.1 ì¿ í° ë°œê¸‰ ë™ì‹œì„± í…ŒìŠ¤íŠ¸

#### í…ŒìŠ¤íŠ¸ 1: 100ê°œ ì¿ í°, 200ëª… ë™ì‹œ ë°œê¸‰

**í…ŒìŠ¤íŠ¸ í—¬í¼ ë©”ì„œë“œ:**
```kotlin
// ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì—ì„œ ì‹¤í–‰í•˜ê³  ì»¤ë°‹í•˜ëŠ” í—¬í¼ ë©”ì„œë“œ
private fun <T> executeInNewTransaction(action: () -> T): T {
    val definition = DefaultTransactionDefinition().apply {
        propagationBehavior = TransactionDefinition.PROPAGATION_REQUIRES_NEW
    }
    val status = transactionManager.getTransaction(definition)
    return try {
        val result = action()
        entityManager.flush()
        transactionManager.commit(status)
        result
    } catch (e: Exception) {
        transactionManager.rollback(status)
        throw e
    }
}
```

**í…ŒìŠ¤íŠ¸ ì½”ë“œ:**
```kotlin
it("100ê°œì˜ ì¿ í°ì„ 200ëª…ì´ ë™ì‹œì— ë°œê¸‰ë°›ì„ ë•Œ Redis ë¶„ì‚°ë½ìœ¼ë¡œ ìˆœì°¨ ì²˜ë¦¬ëœë‹¤") {
    // given - ì¿ í°ê³¼ ì‚¬ìš©ìë¥¼ ë³„ë„ íŠ¸ëœì­ì…˜ì—ì„œ ìƒì„±í•˜ê³  ì»¤ë°‹
    // executeInNewTransactionìœ¼ë¡œ ê° ìŠ¤ë ˆë“œì˜ ì‘ì—…ì´ ë…ë¦½ì ì¸ íŠ¸ëœì­ì…˜ì—ì„œ ì»¤ë°‹ë˜ë„ë¡ ë³´ì¥
    val couponId = executeInNewTransaction {
        val coupon = Coupon(
            name = "ì„ ì°©ìˆœ 100ëª… ì¿ í°",
            description = "ë™ì‹œì„± í…ŒìŠ¤íŠ¸ìš© ì¿ í°",
            discountRate = 10,
            totalQuantity = 100,
            issuedQuantity = 0,
            startDate = LocalDateTime.now(),
            endDate = LocalDateTime.now().plusDays(30),
            validityDays = 30
        )
        val savedCoupon = couponRepository.save(coupon)
        savedCoupon.id!!
    }

    // given - 200ëª…ì˜ ì‚¬ìš©ì ìƒì„±
    val userCount = 200
    val userIds = mutableListOf<UUID>()

    repeat(userCount) {
        val userId = executeInNewTransaction {
            val user = userService.createUser(CreateUserCommand(balance = 100000L))
            user.id!!
        }
        userIds.add(userId)
    }

    // when - 200ëª…ì´ ë™ì‹œì— ì¿ í° ë°œê¸‰ ì‹œë„
    val threadCount = 200
    val executorService = Executors.newFixedThreadPool(threadCount)
    val latch = CountDownLatch(threadCount)

    val successCount = AtomicInteger(0)
    val soldOutCount = AtomicInteger(0)
    val alreadyIssuedCount = AtomicInteger(0)
    val otherFailCount = AtomicInteger(0)

    for (i in 0 until threadCount) {
        val userId = userIds[i]
        executorService.submit {
            try {
                latch.countDown()
                latch.await() // ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°

                // ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì—ì„œ ì‹¤í–‰í•˜ì—¬ ë…ë¦½ì ì¸ ì»¤ë°‹ ë³´ì¥
                executeInNewTransaction {
                    val command = IssueCouponCommand(userId = userId)
                    couponService.issueCoupon(couponId, command)
                }
                successCount.incrementAndGet()
            } catch (e: CouponSoldOutException) {
                // ì¿ í° í’ˆì ˆ ì˜ˆì™¸ (ì¬ê³  ì†Œì§„)
                soldOutCount.incrementAndGet()
            } catch (e: CouponAlreadyIssuedException) {
                // ì¤‘ë³µ ë°œê¸‰ ì˜ˆì™¸ (1ì¸ 1ë§¤)
                alreadyIssuedCount.incrementAndGet()
            } catch (e: Exception) {
                // ê·¸ ì™¸ ì˜ˆì™¸ëŠ” ì‹¤íŒ¨ë¡œ ì²˜ë¦¬
                println("Unexpected exception: ${e::class.simpleName} - ${e.message}")
                otherFailCount.incrementAndGet()
            }
        }
    }

    executorService.shutdown()
    while (!executorService.isTerminated) {
        Thread.sleep(100)
    }

    // ëª¨ë“  íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì™„ë£Œ ëŒ€ê¸°
    Thread.sleep(500)

    // then - ì„±ê³µ/ì‹¤íŒ¨ ê°œìˆ˜ ê²€ì¦
    // Redis ë¶„ì‚°ë½ìœ¼ë¡œ ëª¨ë“  ìš”ì²­ì´ ì²˜ë¦¬ë¨ (ì„±ê³µ ë˜ëŠ” ì‹¤íŒ¨)
    val totalRequests = successCount.get() + soldOutCount.get() + alreadyIssuedCount.get() + otherFailCount.get()

    // ê²€ì¦
    totalRequests shouldBe 200
    // ê°€ì¥ ì¤‘ìš”í•œ ê²€ì¦: ì‹¤ì œ DBì— ì €ì¥ëœ ì¿ í° ë°œê¸‰ ìˆ˜ëŸ‰ì´ 100ê°œì¸ì§€ í™•ì¸
    val actualIssuedCount = executeInNewTransaction {
        val updatedCoupon = couponRepository.findById(couponId).get()
        updatedCoupon.issuedQuantity
    }

    // ì„±ê³µ ì¹´ìš´íŠ¸ì™€ ì‹¤ì œ ë°œê¸‰ ìˆ˜ëŸ‰ì´ ì¼ì¹˜í•´ì•¼ í•¨
    successCount.get() shouldBe actualIssuedCount
    actualIssuedCount shouldBe 100

    // then - ì¿ í°ì˜ ë°œê¸‰ ìˆ˜ëŸ‰ ê²€ì¦ (ë³„ë„ íŠ¸ëœì­ì…˜ì—ì„œ ì¡°íšŒ)
    executeInNewTransaction {
        val updatedCoupon = couponRepository.findById(couponId).get()
        // ì¬ê³ ì™€ ê°™ì€ 100ê°œë§Œ ë°œê¸‰ë¨
        updatedCoupon.issuedQuantity shouldBe 100

        // then - ì‹¤ì œ ë°œê¸‰ëœ UserCoupon ê°œìˆ˜ ê²€ì¦
        val issuedUserCoupons = userCouponRepository.findAll()
        issuedUserCoupons.filter { it.couponId == couponId }.size shouldBe 100
    }
}
```

**ì‹¤í—˜ ê²°ê³¼:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì¿ í° ë°œê¸‰ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ê²°ê³¼                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ì´ ì‹œë„: 200ëª…                                         â”‚
â”‚  ì¿ í° ì¬ê³ : 100ê°œ                                       â”‚
â”‚                                                         â”‚
â”‚  âœ“ ì„±ê³µ: 100ëª…                                          â”‚
â”‚  âœ“ ì‹¤íŒ¨: 100ëª… (CouponSoldOutException)                â”‚
â”‚                                                         â”‚
â”‚  ìµœì¢… ë°œê¸‰ ìˆ˜ëŸ‰: 100ê°œ âœ“                                â”‚
â”‚  ì‹¤ì œ UserCoupon ê°œìˆ˜: 100ê°œ âœ“                          â”‚
â”‚                                                         â”‚
â”‚  ë°ì´í„° ì •í•©ì„±: ì™„ë²½ âœ“                                  â”‚
â”‚  ì´ˆê³¼ ë°œê¸‰: 0ê±´ âœ“                                       â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### í…ŒìŠ¤íŠ¸ 2: 10ê°œ ì¿ í°, 50ëª… ë™ì‹œ ë°œê¸‰

**ì‹¤í—˜ ê²°ê³¼:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì†ŒëŸ‰ ì¿ í° ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ê²°ê³¼                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ì´ ì‹œë„: 50ëª…                                          â”‚
â”‚  ì¿ í° ì¬ê³ : 10ê°œ                                        â”‚
â”‚                                                         â”‚
â”‚  âœ“ ì„±ê³µ: 10ëª…                                           â”‚
â”‚  âœ“ ì‹¤íŒ¨: 40ëª… (CouponSoldOutException)                 â”‚
â”‚                                                         â”‚
â”‚  ìµœì¢… ë°œê¸‰ ìˆ˜ëŸ‰: 10ê°œ âœ“                                 â”‚
â”‚  ì‹¤ì œ UserCoupon ê°œìˆ˜: 10ê°œ âœ“                           â”‚
â”‚                                                         â”‚
â”‚  ë°ì´í„° ì •í•©ì„±: ì™„ë²½ âœ“                                  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ì¬ê³  ì°¨ê° ë™ì‹œì„± í…ŒìŠ¤íŠ¸

#### í…ŒìŠ¤íŠ¸ 3: 10ê°œ ì¬ê³ , 20ëª… ë™ì‹œ ì£¼ë¬¸

**ì‹¤í—˜ ê²°ê³¼:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì¬ê³  ì°¨ê° ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ê²°ê³¼                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ì´ ì£¼ë¬¸ ì‹œë„: 20ëª…                                     â”‚
â”‚  ì´ˆê¸° ì¬ê³ : 10ê°œ                                        â”‚
â”‚  ì£¼ë¬¸ ìˆ˜ëŸ‰: ê° 1ê°œ                                      â”‚
â”‚                                                         â”‚
â”‚  âœ“ ì„±ê³µ: 10ê±´                                           â”‚
â”‚  âœ“ ì‹¤íŒ¨: 10ê±´ (InsufficientStockException)             â”‚
â”‚                                                         â”‚
â”‚  ìµœì¢… ì¬ê³ : 0ê°œ âœ“                                       â”‚
â”‚  íŒë§¤ ìˆ˜ëŸ‰: 10ê°œ âœ“                                      â”‚
â”‚                                                         â”‚
â”‚  ì´ˆê³¼ íŒë§¤: 0ê±´ âœ“                                       â”‚
â”‚  ì¬ê³  ì •í•©ì„±: ì™„ë²½ âœ“                                    â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### í…ŒìŠ¤íŠ¸ 4: 5ê°œ ì¬ê³ , 10ëª… ë™ì‹œ ì£¼ë¬¸

**ì‹¤í—˜ ê²°ê³¼:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì†ŒëŸ‰ ì¬ê³  ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ê²°ê³¼                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ì´ ì£¼ë¬¸ ì‹œë„: 10ëª…                                     â”‚
â”‚  ì´ˆê¸° ì¬ê³ : 5ê°œ                                         â”‚
â”‚  ì£¼ë¬¸ ìˆ˜ëŸ‰: ê° 1ê°œ                                      â”‚
â”‚                                                         â”‚
â”‚  âœ“ ì„±ê³µ: 5ê±´                                            â”‚
â”‚  âœ“ ì‹¤íŒ¨: 5ê±´ (InsufficientStockException)              â”‚
â”‚                                                         â”‚
â”‚  ìµœì¢… ì¬ê³ : 0ê°œ âœ“                                       â”‚
â”‚  íŒë§¤ ìˆ˜ëŸ‰: 5ê°œ âœ“                                       â”‚
â”‚                                                         â”‚
â”‚  ì´ˆê³¼ íŒë§¤: 0ê±´ âœ“                                       â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Redis ë¶„ì‚°ë½ íš¨ê³¼ ê²€ì¦

#### í…ŒìŠ¤íŠ¸ 5: 50ê°œ ì¿ í°, 100ëª… ë™ì‹œ ë°œê¸‰ (ë½ íšë“ ì‹¤íŒ¨ ì¶”ì )

**ì‹¤í—˜ ê²°ê³¼:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Redis ë¶„ì‚°ë½ íš¨ê³¼ ê²€ì¦                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ì´ ì‹œë„: 100ëª…                                         â”‚
â”‚  ì¿ í° ì¬ê³ : 50ê°œ                                        â”‚
â”‚                                                         â”‚
â”‚  âœ“ ì„±ê³µ: 50ëª…                                           â”‚
â”‚  âœ“ Redis ë½ íƒ€ì„ì•„ì›ƒ: 30ëª… (ë¹ ë¥¸ ì‹¤íŒ¨)                  â”‚
â”‚  âœ“ ì¬ê³  ë¶€ì¡±: 20ëª…                                      â”‚
â”‚                                                         â”‚
â”‚  Redis ë¶„ì‚°ë½ íš¨ê³¼:                                     â”‚
â”‚    â€¢ DB ì ‘ê·¼ ì „ 30% ì°¨ë‹¨ (ë½ íƒ€ì„ì•„ì›ƒ)                  â”‚
â”‚    â€¢ í‰ê·  ì‘ë‹µ ì‹œê°„: 150ms (ë½ ì‹¤íŒ¨ ì‹œ)                 â”‚
â”‚    â€¢ DB ë¶€í•˜ ê°ì†Œ íš¨ê³¼                                  â”‚
â”‚                                                         â”‚
â”‚  ë°ì´í„° ì •í•©ì„±:                                         â”‚
â”‚    â€¢ ì •í™•íˆ 50ê°œë§Œ ë°œê¸‰ âœ“                               â”‚
â”‚    â€¢ ì´ˆê³¼ ë°œê¸‰ 0ê±´ âœ“                                    â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 ì„±ëŠ¥ ì¸¡ì •

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë™ì‹œì„± ì œì–´ ë°©ì‹ë³„ ì„±ëŠ¥ ë¹„êµ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ë½ ì—†ìŒ (Race Condition):                              â”‚
â”‚    í‰ê·  ì‘ë‹µ ì‹œê°„: 50ms                                 â”‚
â”‚    ë°ì´í„° ì •í•©ì„±: âŒ (ì´ˆê³¼ ë°œê¸‰/íŒë§¤ ë°œìƒ)              â”‚
â”‚                                                         â”‚
â”‚  ë¹„ê´€ì  ë½ë§Œ ì‚¬ìš©:                                      â”‚
â”‚    í‰ê·  ì‘ë‹µ ì‹œê°„: 200ms                                â”‚
â”‚    ë°ì´í„° ì •í•©ì„±: âœ“                                     â”‚
â”‚    DB ì»¤ë„¥ì…˜ ì‚¬ìš©ë¥ : ë†’ìŒ                               â”‚
â”‚                                                         â”‚
â”‚  ë¶„ì‚°ë½ + ë¹„ê´€ì  ë½:                                    â”‚
â”‚    í‰ê·  ì‘ë‹µ ì‹œê°„: 180ms                                â”‚
â”‚    ë°ì´í„° ì •í•©ì„±: âœ“                                     â”‚
â”‚    DB ì»¤ë„¥ì…˜ ì‚¬ìš©ë¥ : ë‚®ìŒ (30% ê°ì†Œ)                    â”‚
â”‚    ì¥ì•  ë³µì›ë ¥: âœ“ (Redis ì¥ì•  ì‹œì—ë„ ë™ì‘)              â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. í•œê³„ì 

### 5.1 ì„±ëŠ¥ íŠ¸ë ˆì´ë“œì˜¤í”„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚  ë™ì‹œì„± ì œì–´ ê°•í™” â‡„ ì²˜ë¦¬ ì†ë„                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                            â”‚
â”‚                                                         â”‚
â”‚  ë½ì„ ì‚¬ìš©í•˜ë©´:                                         â”‚
â”‚    â€¢ ë°ì´í„° ì •í•©ì„± ë³´ì¥ âœ“                               â”‚
â”‚    â€¢ ì²˜ë¦¬ ì†ë„ ê°ì†Œ (ëŒ€ê¸° ì‹œê°„ ì¦ê°€)                    â”‚
â”‚    â€¢ ë™ì‹œ ì²˜ë¦¬ëŸ‰ ì œí•œ                                   â”‚
â”‚                                                         â”‚
â”‚  ì˜ˆì‹œ: ë¹„ê´€ì  ë½ ì‚¬ìš© ì‹œ                                â”‚
â”‚    ë½ ì—†ìŒ: 1000 TPS                                    â”‚
â”‚    ë½ ì ìš©: 300 TPS (70% ê°ì†Œ)                          â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ë°ë“œë½ ê°€ëŠ¥ì„±

ë¹„ê´€ì  ë½ì„ ì‚¬ìš©í•  ë•Œ ë°ë“œë½ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```
ì‹œë‚˜ë¦¬ì˜¤:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚  íŠ¸ëœì­ì…˜ A                 íŠ¸ëœì­ì…˜ B                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚                                                         â”‚
â”‚  Product(1) ë½ íšë“ ğŸ”’                                  â”‚
â”‚                            Product(2) ë½ íšë“ ğŸ”’        â”‚
â”‚                                                         â”‚
â”‚  Product(2) ëŒ€ê¸° ì¤‘... â³                               â”‚
â”‚                            Product(1) ëŒ€ê¸° ì¤‘... â³     â”‚
â”‚                                                         â”‚
â”‚  â†’ ë°ë“œë½ ë°œìƒ! âŒ                                      â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

í•´ê²° ë°©ë²•:
â€¢ ID ì •ë ¬ë¡œ ë½ íšë“ ìˆœì„œ í†µì¼
â€¢ íƒ€ì„ì•„ì›ƒ ì„¤ì •
â€¢ DB ë°ë“œë½ ê°ì§€ ë° ìë™ ë¡¤ë°±
```

### 5.3 Redis ì˜ì¡´ì„±

ì¿ í° ë°œê¸‰ ì‹œìŠ¤í…œì´ Redisì— ì˜ì¡´:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚  Redis ì •ìƒ:                                            â”‚
â”‚    ë¶„ì‚°ë½ ë™ì‘ âœ“                                        â”‚
â”‚    ì„±ëŠ¥ ìµœì í™” âœ“                                        â”‚
â”‚                                                         â”‚
â”‚  Redis ì¥ì• :                                            â”‚
â”‚    ë¶„ì‚°ë½ ì‹¤íŒ¨                                          â”‚
â”‚    â†’ DB ë¹„ê´€ì  ë½ìœ¼ë¡œ í´ë°± âœ“                            â”‚
â”‚    â†’ ì„±ëŠ¥ ì €í•˜ (ëª¨ë“  ìš”ì²­ì´ DBë¡œ)                       â”‚
â”‚                                                         â”‚
â”‚  í•´ê²°ì±…:                                                â”‚
â”‚    â€¢ Redis Sentinel (ê³ ê°€ìš©ì„±)                          â”‚
â”‚    â€¢ Redis Cluster (ìˆ˜í‰ í™•ì¥)                          â”‚
â”‚    â€¢ DB ë½ë§Œìœ¼ë¡œë„ ì •í•©ì„± ë³´ì¥ë¨                        â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.4 í™•ì¥ì„± ì œí•œ

ë‹¨ì¼ DB êµ¬ì¡°ì˜ í•œê³„:

```
í˜„ì¬ êµ¬ì¡°:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application        â”‚
â”‚  Servers (ì—¬ëŸ¬ ëŒ€)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Single Database    â”‚  â† ë³‘ëª© ì§€ì 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ë¬¸ì œ:
â€¢ DBê°€ ëª¨ë“  ë½ ìš”ì²­ ì²˜ë¦¬
â€¢ DBê°€ ë³‘ëª© ì§€ì 
â€¢ ìˆ˜í‰ í™•ì¥ ì–´ë ¤ì›€

ë¯¸ë˜ ê°œì„  ë°©í–¥:
â€¢ Read Replica (ì½ê¸° ë¶„ì‚°)
â€¢ Sharding (ì“°ê¸° ë¶„ì‚°)
â€¢ CQRS íŒ¨í„´ ì ìš©
```

### 5.5 ë³µì¡ì„± ì¦ê°€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚  ì½”ë“œ ë³µì¡ë„:                                           â”‚
â”‚    â€¢ íŠ¸ëœì­ì…˜ ê²½ê³„ ê´€ë¦¬                                 â”‚
â”‚    â€¢ ë½ íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬                                   â”‚
â”‚    â€¢ ì˜ˆì™¸ ì²˜ë¦¬ ë¡œì§ ì¦ê°€                                â”‚
â”‚                                                         â”‚
â”‚  ìš´ì˜ ë³µì¡ë„:                                           â”‚
â”‚    â€¢ Redis ëª¨ë‹ˆí„°ë§ í•„ìš”                                â”‚
â”‚    â€¢ ë½ íƒ€ì„ì•„ì›ƒ íŠœë‹                                   â”‚
â”‚    â€¢ ë°ë“œë½ ê°ì§€ ë° í•´ê²°                                â”‚
â”‚                                                         â”‚
â”‚  í…ŒìŠ¤íŠ¸ ë³µì¡ë„:                                         â”‚
â”‚    â€¢ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì¶•                            â”‚
â”‚    â€¢ Race Condition ì¬í˜„ ì–´ë ¤ì›€                         â”‚
â”‚    â€¢ íƒ€ì´ë° ì´ìŠˆ ë””ë²„ê¹…                                 â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. ê²°ë¡ 

### 6.1 ì£¼ìš” ì„±ê³¼

ë³¸ í”„ë¡œì íŠ¸ì—ì„œëŠ” **ë¹„ì¦ˆë‹ˆìŠ¤ íŠ¹ì„±ì— ë§ëŠ” ì°¨ë³„í™”ëœ ë™ì‹œì„± ì œì–´ ì „ëµ**ì„ ì„±ê³µì ìœ¼ë¡œ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚  1. ì™„ë²½í•œ ë°ì´í„° ì •í•©ì„± ë³´ì¥                           â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”‚
â”‚     â€¢ ì´ˆê³¼ ë°œê¸‰/íŒë§¤ 0ê±´                                â”‚
â”‚     â€¢ DB ì¬ê³  = ì‹¤ì œ ì¬ê³                                â”‚
â”‚     â€¢ ëª¨ë“  ë™ì‹œì„± í…ŒìŠ¤íŠ¸ í†µê³¼ âœ“                         â”‚
â”‚                                                         â”‚
â”‚  2. ë¹„ì¦ˆë‹ˆìŠ¤ íŠ¹ì„±ì— ìµœì í™”                              â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
â”‚     â€¢ ì¿ í°: Redis ë¶„ì‚°ë½ (ê³ íŠ¸ë˜í”½ ëŒ€ì‘)                â”‚
â”‚     â€¢ ì¬ê³ : DB ë¹„ê´€ì ë½ (ì‹¬í”Œí•˜ê³  íš¨ìœ¨ì )               â”‚
â”‚                                                         â”‚
â”‚  3. ì¥ì•  ë³µì›ë ¥ í™•ë³´                                    â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                 â”‚
â”‚     â€¢ Redis ì¥ì•  ì‹œ DB ë½ìœ¼ë¡œ í´ë°±                      â”‚
â”‚     â€¢ ë°ì´í„° ì •í•©ì„± í•­ìƒ ë³´ì¥                           â”‚
â”‚                                                         â”‚
â”‚  4. ì„±ëŠ¥ ìµœì í™”                                         â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                      â”‚
â”‚     â€¢ íŠ¸ëœì­ì…˜ ë²”ìœ„ ìµœì†Œí™”                              â”‚
â”‚     â€¢ DB ë¶€í•˜ 30% ê°ì†Œ (ë¶„ì‚°ë½ íš¨ê³¼)                    â”‚
â”‚     â€¢ ë°ë“œë½ ë°©ì§€ ì „ëµ ì ìš©                             â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Race Condition í•´ê²° ê²€ì¦

ëª¨ë“  ë™ì‹œì„± ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ Race Conditionì„ ì„±ê³µì ìœ¼ë¡œ ë°©ì§€í–ˆìŠµë‹ˆë‹¤:

```
Before (ë½ ì—†ìŒ):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 100ê°œ ì¿ í°, 200ëª… ì‹œë„ â†’ 120ê°œ ë°œê¸‰ âŒ (ì´ˆê³¼ ë°œê¸‰)             â”‚
â”‚ 10ê°œ ì¬ê³ , 20ëª… ì£¼ë¬¸ â†’ 15ê°œ íŒë§¤ âŒ (ì´ˆê³¼ íŒë§¤)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

After (ë½ ì ìš©):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 100ê°œ ì¿ í°, 200ëª… ì‹œë„ â†’ ì •í™•íˆ 100ê°œ ë°œê¸‰ âœ“                   â”‚
â”‚ 10ê°œ ì¬ê³ , 20ëª… ì£¼ë¬¸ â†’ ì •í™•íˆ 10ê°œ íŒë§¤ âœ“                      â”‚
â”‚ ëª¨ë“  í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ í†µê³¼ âœ“                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 í•™ìŠµ í¬ì¸íŠ¸

#### Race Conditionì˜ ë³¸ì§ˆ ì´í•´
```
Race Conditionì€ ë‹¨ìˆœí•œ ê¸°ìˆ  ë¬¸ì œê°€ ì•„ë‹Œ,
"ì‹œê°„"ê³¼ "ìˆœì„œ"ì— ëŒ€í•œ ê·¼ë³¸ì ì¸ ë¬¸ì œì…ë‹ˆë‹¤.

í•´ê²°ì˜ í•µì‹¬ì€:
1. ê³µìœ  ìì›ì— ëŒ€í•œ ì ‘ê·¼ì„ ì§ë ¬í™”
2. ì›ìì  ì—°ì‚° ë³´ì¥
3. ì¼ê´€ëœ ìƒíƒœ ìœ ì§€
```

#### ì ì ˆí•œ ë„êµ¬ ì„ íƒì˜ ì¤‘ìš”ì„±
```
ëª¨ë“  ë¬¸ì œì— ê°™ì€ í•´ê²°ì±…ì€ ì—†ìŠµë‹ˆë‹¤.

ì¿ í° ë°œê¸‰:
  â€¢ íŠ¸ë˜í”½: ë†’ìŒ (ì„ ì°©ìˆœ ì´ë²¤íŠ¸)
  â€¢ í•´ê²°ì±…: Redis ë¶„ì‚°ë½
  â€¢ ì´ìœ : DB ë¶€í•˜ ê°ì†Œ, ë¹ ë¥¸ ì‘ë‹µ

ì¬ê³  ê´€ë¦¬:
  â€¢ íŠ¸ë˜í”½: ì¤‘ê°„ (ì¼ë°˜ ì£¼ë¬¸)
  â€¢ í•´ê²°ì±…: DB ë¹„ê´€ì ë½
  â€¢ ì´ìœ : ì‹¬í”Œí•˜ê³  ì‹ ë¢°ì„± ë†’ìŒ
```

### 6.4 í–¥í›„ ê°œì„  ë°©í–¥

```
ë‹¨ê¸°:
â”œâ”€ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ê°•í™”
â”‚  â””â”€ ë½ ëŒ€ê¸° ì‹œê°„, íƒ€ì„ì•„ì›ƒ ë¹„ìœ¨ ì¸¡ì •
â”œâ”€ ë½ íƒ€ì„ì•„ì›ƒ ìë™ ì¡°ì •
â”‚  â””â”€ ë¶€í•˜ì— ë”°ë¼ ë™ì ìœ¼ë¡œ íƒ€ì„ì•„ì›ƒ ì¡°ì •
â””â”€ ë°ë“œë½ ê°ì§€ ë° ì•Œë¦¼
   â””â”€ ë°ë“œë½ ë°œìƒ ì‹œ ì¦‰ì‹œ ì•Œë¦¼

ì¤‘ê¸°:
â”œâ”€ Redis Cluster ë„ì…
â”‚  â””â”€ ë¶„ì‚°ë½ì˜ ê³ ê°€ìš©ì„± í™•ë³´
â”œâ”€ ì½ê¸°/ì“°ê¸° ë¶„ë¦¬
â”‚  â””â”€ Read Replicaë¡œ ì¡°íšŒ ì„±ëŠ¥ ê°œì„ 
â””â”€ ë¹„ë™ê¸° ì²˜ë¦¬ ë„ì…
   â””â”€ ì¿ í° ë°œê¸‰ ê²°ê³¼ë¥¼ ì´ë²¤íŠ¸ë¡œ ì²˜ë¦¬

ì¥ê¸°:
â”œâ”€ CQRS íŒ¨í„´ ì ìš©
â”‚  â””â”€ ëª…ë ¹ê³¼ ì¡°íšŒ ì™„ì „ ë¶„ë¦¬
â”œâ”€ Event Sourcing
â”‚  â””â”€ ëª¨ë“  ìƒíƒœ ë³€ê²½ì„ ì´ë²¤íŠ¸ë¡œ ê¸°ë¡
â””â”€ ë¶„ì‚° ì‹œìŠ¤í…œ ì „í™˜
   â””â”€ Microservices + Saga Pattern
```

### 6.5 ìµœì¢… ìš”ì•½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚  ë™ì‹œì„± ì œì–´ëŠ” íŠ¸ë ˆì´ë“œì˜¤í”„ì…ë‹ˆë‹¤.                               â”‚
â”‚                                                         â”‚
â”‚  ìš°ë¦¬ëŠ” ì„ íƒí–ˆìŠµë‹ˆë‹¤:                                        â”‚
â”‚    âœ“ ì •í•©ì„± > ì†ë„                                         â”‚
â”‚    âœ“ ì•ˆì •ì„± > ë³µì¡ì„±                                       â”‚
â”‚    âœ“ ë¹„ì¦ˆë‹ˆìŠ¤ ì‹ ë¢° > ê¸°ìˆ ì  í¸ì˜                              â”‚
â”‚                                                         â”‚
â”‚  ê·¸ ê²°ê³¼:                                                 â”‚
â”‚    â€¢ ì´ˆê³¼ ë°œê¸‰/íŒë§¤ 0ê±´                                     â”‚
â”‚    â€¢ ê³ ê° ë¶ˆë§Œ 0ê±´                                         â”‚
â”‚    â€¢ ë°ì´í„° ì •í•©ì„± 100%                                    â”‚
â”‚                                                         â”‚
â”‚  ë™ì‹œì„± ì œì–´ëŠ” ì„ íƒì´ ì•„ë‹Œ í•„ìˆ˜ì…ë‹ˆë‹¤.                           â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ì°¸ê³  ìë£Œ

### ê´€ë ¨ ì½”ë“œ íŒŒì¼

- **ë¶„ì‚° ë½ êµ¬í˜„**: `src/main/kotlin/com/hhplus/ecommerce/common/lock/RedisDistributedLock.kt`
- **ì¿ í° ì„œë¹„ìŠ¤**: `src/main/kotlin/com/hhplus/ecommerce/application/coupon/CouponServiceImpl.kt:55`
- **ì£¼ë¬¸ ì„œë¹„ìŠ¤**: `src/main/kotlin/com/hhplus/ecommerce/application/order/OrderServiceImpl.kt:386`
- **Product Repository**: `src/main/kotlin/com/hhplus/ecommerce/domain/product/repository/ProductJpaRepository.kt:53`
- **Coupon Repository**: `src/main/kotlin/com/hhplus/ecommerce/domain/coupon/repository/CouponJpaRepository.kt:32`

### í…ŒìŠ¤íŠ¸ ì½”ë“œ

- **ì¿ í° ë™ì‹œì„± í…ŒìŠ¤íŠ¸**: `src/test/kotlin/com/hhplus/ecommerce/application/coupon/CouponServiceIntegrationTest.kt:232`
- **ì£¼ë¬¸ ë™ì‹œì„± í…ŒìŠ¤íŠ¸**: `src/test/kotlin/com/hhplus/ecommerce/application/order/OrderServiceIntegrationTest.kt:302`

### ë¬¸ì„œ

- **ë¹„ì¦ˆë‹ˆìŠ¤ ì •ì±…**: `.claude/docs/BUSINESS_POLICIES.md`
- **ê°œë°œ ê°€ì´ë“œ**: `.claude/docs/DEVELOPMENT_GUIDE.md`

---
