# 이커머스 시스템 요구사항 정의

## 프로젝트 개요
이커머스 플랫폼의 핵심 기능(상품 조회, 주문/결제, 쿠폰 시스템, 잔액 관리)을 제공하는 백엔드 API 시스템

## 1. 기능적 요구사항 (Functional Requirements)

### 1.1 사용자 관리
- **FR-1.1**: 사용자는 시스템에 등록할 수 있어야 함
- **FR-1.2**: 사용자는 잔액을 충전할 수 있어야 함
- **FR-1.3**: 사용자는 자신의 잔액을 조회할 수 있어야 함
- **FR-1.4**: 사용자는 자신의 주문 내역을 조회할 수 있어야 함
- **FR-1.5**: 사용자는 보유한 쿠폰 목록을 조회할 수 있어야 함

### 1.2 상품 관리
- **FR-2.1**: 사용자는 전체 상품 목록을 조회할 수 있어야 함
- **FR-2.2**: 사용자는 카테고리별로 상품을 필터링할 수 있어야 함
- **FR-2.3**: 사용자는 특정 상품의 재고를 실시간으로 확인할 수 있어야 함
- **FR-2.4**: 사용자는 인기 상품(최근 3일, Top 5)을 조회할 수 있어야 함
- **FR-2.5**: 상품 재고는 주문 생성 시점에 차감되어야 함

### 1.3 주문/결제 시스템
- **FR-3.1**: 사용자는 여러 상품을 포함한 주문을 생성할 수 있어야 함
- **FR-3.2**: 주문 생성 시 쿠폰을 적용할 수 있어야 함 (선택사항)
- **FR-3.3**: 주문 생성 시 재고가 충분한지 검증해야 함
- **FR-3.4**: 주문 생성 시 사용자 잔액이 충분한지 검증해야 함
- **FR-3.5**: 사용자는 특정 주문의 상세 정보를 조회할 수 있어야 함
- **FR-3.6**: 사용자는 자신의 모든 주문 목록을 조회할 수 있어야 함
- **FR-3.7**: 결제 완료 시 주문 상태가 PAID로 변경되어야 함
- **FR-3.8**: 결제 실패 시 재고 및 쿠폰이 복원되어야 함

### 1.4 쿠폰 시스템
- **FR-4.1**: 사용자는 선착순으로 쿠폰을 발급받을 수 있어야 함
- **FR-4.2**: 쿠폰은 1인 1매만 발급 가능해야 함 (중복 발급 방지)
- **FR-4.3**: 쿠폰 발급 수량이 제한되어 있어야 함 (선착순)
- **FR-4.4**: 사용자는 현재 사용 가능한 쿠폰 목록을 조회할 수 있어야 함
- **FR-4.5**: 쿠폰은 유효기간이 있어야 함 (발급 후 30일)
- **FR-4.6**: 주문 시 AVAILABLE 상태의 쿠폰만 사용 가능해야 함
- **FR-4.7**: 쿠폰 사용 후 상태가 USED로 변경되어야 함

### 1.5 데이터 전송 (Outbox Pattern)
- **FR-5.1**: 결제 완료 시 외부 시스템으로 주문 데이터를 전송해야 함
- **FR-5.2**: 데이터 전송 실패 시 재시도 메커니즘이 있어야 함
- **FR-5.3**: 최대 3회 재시도 후에도 실패 시 관리자에게 알림이 가야 함
- **FR-5.4**: 중복 전송을 방지해야 함 (멱등성 보장)

---

## 2. 비기능적 요구사항 (Non-Functional Requirements)

### 2.1 성능 (Performance)
- **NFR-1.1**: 주문 생성 API는 1초 이내에 응답해야 함
- **NFR-1.2**: 결제 처리는 2초 이내에 완료되어야 함
- **NFR-1.3**: 쿠폰 발급은 500ms 이내에 처리되어야 함
- **NFR-1.4**: 동일 상품에 대한 동시 주문을 최소 100 TPS 처리할 수 있어야 함
- **NFR-1.5**: 동일 쿠폰에 대한 동시 발급을 최소 50 TPS 처리할 수 있어야 함

### 2.2 확장성 (Scalability)
- **NFR-2.1**: 수평적 확장이 가능한 아키텍처여야 함
- **NFR-2.2**: 데이터베이스 커넥션 풀을 효율적으로 관리해야 함
- **NFR-2.3**: 캐싱 전략을 적용할 수 있어야 함 (향후 확장)

### 2.3 신뢰성 (Reliability)
- **NFR-3.1**: 트랜잭션 롤백이 정확하게 동작해야 함
- **NFR-3.2**: 동시성 문제로 인한 데이터 불일치가 발생하지 않아야 함
- **NFR-3.3**: 결제 실패 시 보상 트랜잭션이 정확히 실행되어야 함
- **NFR-3.4**: 시스템 장애 시에도 데이터 손실이 없어야 함

### 2.4 보안 (Security)
- **NFR-4.1**: JWT 기반 인증을 사용해야 함
- **NFR-4.2**: 사용자는 자신의 데이터만 조회/수정할 수 있어야 함
- **NFR-4.3**: API 요청에 대한 인증 및 인가가 이루어져야 함
- **NFR-4.4**: 민감한 정보(비밀번호 등)는 암호화되어야 함

### 2.5 유지보수성 (Maintainability)
- **NFR-5.1**: 코드는 단일 책임 원칙을 따라야 함
- **NFR-5.2**: 각 도메인은 명확하게 분리되어야 함
- **NFR-5.3**: 비즈니스 로직은 서비스 레이어에서 처리해야 함
- **NFR-5.4**: 예외 처리는 일관된 방식으로 이루어져야 함

### 2.6 테스트 가능성 (Testability)
- **NFR-6.1**: 단위 테스트 작성이 가능해야 함
- **NFR-6.2**: 통합 테스트 작성이 가능해야 함
- **NFR-6.3**: 동시성 시나리오 테스트가 가능해야 함
- **NFR-6.4**: 테스트 커버리지 80% 이상을 목표로 함

---

## 3. 사용자 역할 및 권한

### 3.1 일반 사용자 (User)
- 상품 조회 (목록, 상세, 재고, 인기 상품)
- 주문 생성 및 조회 (본인 주문만)
- 쿠폰 발급 및 조회 (본인 쿠폰만)
- 잔액 충전 및 조회 (본인 잔액만)

### 3.2 관리자 (Admin) - 향후 구현
- 상품 등록/수정/삭제
- 쿠폰 생성/수정
- 전체 주문 조회 및 관리
- 사용자 관리
- 통계 및 리포트 조회

---

## 4. 비즈니스 규칙 및 제약사항

### 4.1 주문 관련 규칙
- 주문은 최소 1개 이상의 상품을 포함해야 함
- 주문 시 재고가 즉시 차감됨 (예약)
- 결제 완료 전까지 주문 상태는 PENDING
- PENDING 상태의 주문만 취소 가능
- 한 주문에 하나의 쿠폰만 사용 가능

### 4.2 재고 관련 규칙
- 재고는 0 이상이어야 함
- 재고 차감은 낙관적 락으로 동시성 제어
- 재고 부족 시 주문 생성이 거부됨
- 주문 취소 시 재고가 복원됨

### 4.3 쿠폰 관련 규칙
- 쿠폰은 유효기간 내에만 사용 가능
- 만료된 쿠폰은 사용 불가
- 이미 사용된 쿠폰은 재사용 불가
- 쿠폰 할인율은 10%, 20%, 30% 고정값
- 할인 금액은 소수점 이하 내림 처리

### 4.4 금액 관련 규칙
- 모든 금액은 0 이상이어야 함
- 최종 결제 금액 = 총 주문 금액 - 할인 금액
- 사용자 잔액이 최종 결제 금액보다 적으면 주문 불가
- 결제 완료 시 잔액 차감

### 4.5 데이터 전송 규칙
- 주문이 PAID 상태로 변경될 때만 전송
- 동일 주문에 대한 중복 전송 방지
- 전송 실패 시 최대 3회 재시도
- 재시도 간격: 1분, 5분, 15분 (지수 백오프)

---

## 5. 기술 스택 및 제약사항

### 5.1 기술 스택
- **언어**: Kotlin 1.9.25
- **프레임워크**: Spring Boot 3.5.6
- **데이터베이스**: MySQL
- **ORM**: JPA/Hibernate
- **인증**: JWT (Access Token)
- **빌드 도구**: Gradle

### 5.2 제약사항
- RESTful API 설계 원칙 준수
- HTTP 상태 코드 적절히 사용
- API Base Path: `/api`
- 에러 메시지는 영어로 작성
- 모든 응답은 JSON 형식

---

## 6. 우선순위

### Phase 1 (필수) - 현재 구현 완료
- [x] 사용자 관리 (등록, 잔액 충전/조회)
- [x] 상품 조회 (목록, 재고, 인기 상품)
- [x] 쿠폰 발급 및 조회
- [x] 주문 생성 및 조회

### Phase 2 (필수) - 진행 중
- [ ] 결제 처리 API
- [ ] 데이터 전송 (Outbox Pattern)
- [ ] 주문 취소 기능

### Phase 3 (선택) - 향후 계획
- [ ] 관리자 기능
- [ ] 통계 및 리포트
- [ ] 캐싱 적용
- [ ] 알림 시스템

---

## 7. 제외 사항 (Out of Scope)

### 현재 버전에서 구현하지 않는 기능
- 회원가입/로그인 (JWT 인증은 향후 적용)
- 배송 관리
- 리뷰/평점 시스템
- 장바구니 영구 저장 (세션 기반으로 간주)
- 결제 게이트웨이 연동 (내부 잔액만 사용)
- 환불 처리
- 이메일/SMS 알림
- 관리자 대시보드

---

## 8. 품질 기준 (Acceptance Criteria)

### 8.1 코드 품질
- 모든 코드는 Kotlin 코딩 컨벤션을 따름
- 비즈니스 로직은 엔티티 또는 서비스 레이어에 위치
- 예외 처리는 BaseException을 상속받아 구현
- 모든 public 메서드는 명확한 의도를 가짐

### 8.2 API 품질
- 모든 API는 적절한 HTTP 상태 코드 반환
- 에러 발생 시 명확한 에러 메시지 제공
- 응답 형식은 일관성 있게 유지
- API 문서는 최신 상태로 유지

### 8.3 테스트 품질
- 모든 비즈니스 로직은 테스트 커버리지 80% 이상
- 동시성 시나리오는 별도 테스트로 검증
- 예외 케이스에 대한 테스트 포함
- 통합 테스트로 전체 플로우 검증

---

## 9. 참고 문서
- [비즈니스 정책 문서](../.claude/docs/BUSINESS_POLICIES.md)
- [개발 가이드](../.claude/docs/DEVELOPMENT_GUIDE.md)
- [데이터베이스 스키마](../DATABASE_SCHEMA.md)