# 이커머스 시스템 사용자 스토리

## Epic 1: 사용자 관리

### US-1.1: 잔액 충전
**As a** 사용자
**I want** 내 계정에 잔액을 충전하고 싶다
**So that** 상품을 구매할 수 있다

**Acceptance Criteria:**
- [ ] 사용자는 충전할 금액을 입력할 수 있다
- [ ] 충전 금액은 0보다 커야 한다
- [ ] 충전 후 현재 잔액이 표시된다
- [ ] 충전 이력이 기록된다

**Example:**
```
Given 사용자의 현재 잔액이 10,000원일 때
When 50,000원을 충전하면
Then 잔액이 60,000원이 된다
```

---

### US-1.2: 잔액 조회
**As a** 사용자
**I want** 내 현재 잔액을 확인하고 싶다
**So that** 구매 가능한 금액을 알 수 있다

**Acceptance Criteria:**
- [ ] 사용자는 자신의 잔액만 조회할 수 있다
- [ ] 잔액은 실시간으로 업데이트된다
- [ ] 잔액은 소수점 둘째 자리까지 표시된다

---

## Epic 2: 상품 조회

### US-2.1: 상품 목록 조회
**As a** 사용자
**I want** 판매 중인 상품 목록을 보고 싶다
**So that** 구매할 상품을 선택할 수 있다

**Acceptance Criteria:**
- [ ] 전체 상품 목록이 표시된다
- [ ] 각 상품의 이름, 가격, 재고, 카테고리가 표시된다
- [ ] 카테고리별로 필터링할 수 있다
- [ ] 재고가 0인 상품도 표시되지만 품절 표시가 된다

**Example:**
```
Given 전자제품 카테고리를 선택했을 때
When 상품 목록을 조회하면
Then 노트북, 키보드 등 전자제품만 표시된다
```

---

### US-2.2: 상품 재고 조회
**As a** 사용자
**I want** 특정 상품의 실시간 재고를 확인하고 싶다
**So that** 구매 가능 여부를 판단할 수 있다

**Acceptance Criteria:**
- [ ] 상품 ID로 재고를 조회할 수 있다
- [ ] 현재 재고 수량이 표시된다
- [ ] 재고 상태(판매 가능/품절)가 표시된다

---

### US-2.3: 인기 상품 조회
**As a** 사용자
**I want** 최근 인기 있는 상품을 보고 싶다
**So that** 다른 사람들이 많이 구매하는 상품을 참고할 수 있다

**Acceptance Criteria:**
- [ ] 최근 3일간 판매량 기준 Top 5 상품이 표시된다
- [ ] 각 상품의 판매 수량과 매출이 표시된다
- [ ] 순위가 표시된다
- [ ] PAID 상태의 주문만 집계된다

---

## Epic 3: 쿠폰 시스템

### US-3.1: 쿠폰 발급
**As a** 사용자
**I want** 선착순으로 쿠폰을 발급받고 싶다
**So that** 할인 혜택을 받을 수 있다

**Acceptance Criteria:**
- [ ] 사용자는 쿠폰 ID로 쿠폰을 발급받을 수 있다
- [ ] 동일 쿠폰은 1인 1매만 발급 가능하다
- [ ] 발급 수량이 초과되면 발급이 거부된다
- [ ] 쿠폰 유효기간은 발급일로부터 30일이다
- [ ] 발급된 쿠폰의 남은 수량이 표시된다

**Example:**
```
Given 10% 할인 쿠폰의 총 발급 수량이 100개이고 현재 95개가 발급된 상태일 때
When 사용자가 쿠폰을 발급받으면
Then 발급에 성공하고 남은 수량이 4개라고 표시된다
And 동일 사용자가 다시 발급 시도하면 "이미 발급받은 쿠폰입니다" 에러가 발생한다
```

---

### US-3.2: 보유 쿠폰 조회
**As a** 사용자
**I want** 내가 보유한 쿠폰 목록을 보고 싶다
**So that** 사용 가능한 쿠폰을 확인할 수 있다

**Acceptance Criteria:**
- [ ] 사용자는 자신의 쿠폰만 조회할 수 있다
- [ ] 쿠폰 상태(사용 가능/사용 완료/만료)가 표시된다
- [ ] 쿠폰 할인율과 만료일이 표시된다
- [ ] 만료일이 가까운 순으로 정렬된다

---

## Epic 4: 주문 및 결제

### US-4.1: 주문 생성
**As a** 사용자
**I want** 여러 상품을 한 번에 주문하고 싶다
**So that** 원하는 상품을 구매할 수 있다

**Acceptance Criteria:**
- [ ] 하나 이상의 상품을 선택할 수 있다
- [ ] 각 상품의 수량을 지정할 수 있다
- [ ] 선택적으로 쿠폰을 적용할 수 있다
- [ ] 총 주문 금액, 할인 금액, 최종 결제 금액이 표시된다
- [ ] 재고가 부족하면 주문이 거부된다
- [ ] 잔액이 부족하면 주문이 거부된다
- [ ] 주문 생성 시 재고가 즉시 차감된다
- [ ] 주문 생성 시 쿠폰 상태가 USED로 변경된다
- [ ] 주문 상태는 PENDING으로 설정된다

**Example:**
```
Given 사용자 잔액이 1,000,000원이고
And 노트북(890,000원, 재고 10개)을 2개 주문하고
And 10% 할인 쿠폰을 적용했을 때
When 주문을 생성하면
Then 총 주문 금액은 1,780,000원
And 할인 금액은 178,000원
And 최종 결제 금액은 1,602,000원
And 주문 상태는 PENDING
And 노트북 재고는 8개로 감소
And 쿠폰 상태는 USED로 변경
```

**Failure Cases:**
```
Scenario 1: 재고 부족
Given 노트북 재고가 1개일 때
When 2개를 주문하면
Then "재고가 부족합니다" 에러 발생

Scenario 2: 잔액 부족
Given 사용자 잔액이 10,000원일 때
When 890,000원짜리 상품을 주문하면
Then "잔액이 부족합니다" 에러 발생

Scenario 3: 유효하지 않은 쿠폰
Given 사용자가 보유하지 않은 쿠폰 ID를 입력했을 때
When 주문을 생성하면
Then "사용 가능한 쿠폰이 없습니다" 에러 발생
```

---

### US-4.2: 주문 상세 조회
**As a** 사용자
**I want** 특정 주문의 상세 정보를 보고 싶다
**So that** 주문 내역과 결제 정보를 확인할 수 있다

**Acceptance Criteria:**
- [ ] 주문 ID로 주문을 조회할 수 있다
- [ ] 주문에 포함된 모든 상품 정보가 표시된다
- [ ] 각 상품의 수량, 단가, 소계가 표시된다
- [ ] 총 금액, 할인 금액, 최종 결제 금액이 표시된다
- [ ] 주문 상태가 표시된다
- [ ] 주문 생성 일시와 결제 일시가 표시된다

---

### US-4.3: 주문 목록 조회
**As a** 사용자
**I want** 내가 생성한 모든 주문을 보고 싶다
**So that** 주문 이력을 관리할 수 있다

**Acceptance Criteria:**
- [ ] 사용자는 자신의 주문만 조회할 수 있다
- [ ] 최신 주문이 먼저 표시된다
- [ ] 각 주문의 기본 정보(주문번호, 금액, 상태, 일시)가 표시된다
- [ ] 주문 상태별로 필터링할 수 있다 (향후)

---

### US-4.4: 결제 처리 (진행 중)
**As a** 사용자
**I want** PENDING 상태의 주문을 결제하고 싶다
**So that** 주문을 확정할 수 있다

**Acceptance Criteria:**
- [ ] PENDING 상태의 주문만 결제할 수 있다
- [ ] 결제 시 사용자 잔액이 차감된다
- [ ] 결제 성공 시 주문 상태가 PAID로 변경된다
- [ ] 결제 성공 시 외부 시스템으로 데이터가 전송된다
- [ ] 결제 실패 시 재고와 쿠폰이 복원된다
- [ ] 결제 실패 시 주문 상태가 CANCELLED로 변경된다

**Example:**
```
Given PENDING 상태의 주문(최종 금액 100,000원)이 있고
And 사용자 잔액이 500,000원일 때
When 결제를 실행하면
Then 잔액이 400,000원으로 감소
And 주문 상태가 PAID로 변경
And 결제 일시가 기록됨
And 외부 시스템으로 데이터 전송 요청이 생성됨
```

---

### US-4.5: 주문 취소 (진행 중)
**As a** 사용자
**I want** PENDING 상태의 주문을 취소하고 싶다
**So that** 잘못된 주문을 되돌릴 수 있다

**Acceptance Criteria:**
- [ ] PENDING 상태의 주문만 취소할 수 있다
- [ ] 취소 시 차감된 재고가 복원된다
- [ ] 취소 시 사용된 쿠폰이 AVAILABLE 상태로 복원된다
- [ ] 취소 시 주문 상태가 CANCELLED로 변경된다
- [ ] PAID 상태의 주문은 취소할 수 없다 (환불 프로세스 필요)

---

## Epic 5: 데이터 전송 (Outbox Pattern)

### US-5.1: 결제 완료 데이터 전송
**As a** 시스템
**I want** 결제 완료 시 외부 시스템으로 주문 데이터를 전송하고 싶다
**So that** 다른 시스템과 데이터를 동기화할 수 있다

**Acceptance Criteria:**
- [ ] 주문이 PAID 상태로 변경될 때 data_transmissions 레코드가 생성된다
- [ ] 레코드는 주문과 동일한 트랜잭션 내에서 생성된다
- [ ] 초기 상태는 PENDING이다
- [ ] 전송 실패 시 최대 3회 재시도한다
- [ ] 재시도 간격은 지수 백오프(1분, 5분, 15분)를 따른다
- [ ] 3회 재시도 후에도 실패 시 관리자에게 알림이 간다
- [ ] 동일 주문에 대한 중복 전송이 방지된다

**Example:**
```
Given 주문이 PAID 상태로 변경되었을 때
When 데이터 전송 레코드가 생성되면
Then status = PENDING
And attempts = 0
And payload에 주문 정보가 포함됨

When 전송이 실패하면
Then attempts = 1
And status = FAILED
And 1분 후 재시도됨

When 3회 재시도 후에도 실패하면
Then status = FAILED
And attempts = 3
And 관리자에게 알림 발송
```

---

## 테스트 시나리오 우선순위

### P0 (최우선)
- [ ] US-4.1: 주문 생성 (정상 케이스)
- [ ] US-4.1: 재고 부족 시 주문 거부
- [ ] US-4.1: 잔액 부족 시 주문 거부
- [ ] US-3.1: 쿠폰 중복 발급 방지
- [ ] US-3.1: 쿠폰 수량 초과 시 발급 거부

### P1 (높음)
- [ ] US-4.4: 결제 처리 (정상 케이스)
- [ ] US-4.4: 결제 실패 시 보상 트랜잭션
- [ ] US-5.1: 데이터 전송 및 재시도
- [ ] US-2.3: 인기 상품 조회 정확성

### P2 (중간)
- [ ] US-4.5: 주문 취소 및 복원
- [ ] US-1.1: 잔액 충전
- [ ] US-2.1: 상품 목록 조회 및 필터링
- [ ] US-3.2: 보유 쿠폰 조회

### P3 (낮음)
- [ ] US-4.2: 주문 상세 조회
- [ ] US-4.3: 주문 목록 조회
- [ ] US-1.2: 잔액 조회
- [ ] US-2.2: 상품 재고 조회

---

## 동시성 테스트 시나리오

### Concurrency-1: 동시 주문 처리
```
Given 노트북 재고가 10개일 때
When 100명의 사용자가 동시에 1개씩 주문하면
Then 정확히 10개의 주문만 성공해야 함
And 90개의 주문은 "재고 부족" 에러 발생
And 최종 재고는 0개여야 함
```

### Concurrency-2: 동시 쿠폰 발급
```
Given 쿠폰 발급 가능 수량이 100개일 때
When 200명의 사용자가 동시에 발급을 시도하면
Then 정확히 100명만 발급에 성공해야 함
And 100명은 "쿠폰이 매진되었습니다" 에러 발생
And issued_quantity는 100이어야 함
```

### Concurrency-3: 동일 사용자 중복 발급
```
Given 사용자 A가 있을 때
When 사용자 A가 동시에 여러 번 쿠폰 발급을 시도하면
Then 1번만 성공해야 함
And 나머지는 "이미 발급받은 쿠폰입니다" 에러 발생
```