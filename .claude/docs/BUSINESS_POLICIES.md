# 비즈니스 정책 정의

이커머스 시스템의 핵심 비즈니스 규칙과 정책을 정의합니다.

## 1. 주문/결제 정책

### 1.1 주문 생성 규칙
- **주문 생성 조건**
    - 모든 상품의 재고가 주문 수량 이상이어야 함
    - 사용자 잔액이 최종 결제 금액 이상이어야 함
    - 쿠폰 사용 시 쿠폰이 유효한 상태(AVAILABLE)여야 함

- **주문 상태**
  ```
  PENDING  → 주문 생성 완료, 결제 대기
  PAID     → 결제 완료 및 배송 준비중
  CANCELLED → 주문 취소 (결제 실패 또는 사용자 취소)
  ```

### 1.2 결제 프로세스
1. **주문 생성 시**
    - 재고 차감 (비관적 락 사용)
    - 쿠폰 상태를 USED로 변경
    - 주문 상태를 PENDING으로 설정
    - 배송 생성 시 PENDING으로 생성

2. **결제 실행 시**
    - 사용자 잔액 차감
    - 결제 성공 시
      - 주문 상태를 PAID로 변경
      - 배송 준비중 상태의 배송 생성
    - 결제 실패 시 보상 트랜잭션 실행

3. **결제 실패 시 보상 처리**
    - 차감된 재고 복원
    - 사용된 쿠폰 상태를 AVAILABLE로 복원
    - 주문 상태를 CANCELLED로 변경

### 1.3 주문 취소 정책
- PENDING 상태의 주문만 취소 가능
- PENDING 상태의 배송만 취소 가능 
- 취소 시 재고 복원 및 쿠폰 복원 처리
- PAID 상태 주문은 별도 환불 프로세스 필요 (향후 구현)

## 2. 재고 관리 정책

### 2.1 재고 차감 시점
- **주문 생성 시점에 재고 차감** (예약)
- 결제 완료 여부와 관계없이 주문 시 즉시 차감
- 이유: 동시 주문 시 재고 초과 판매 방지

### 2.2 동시성 제어
- **비관적 락(Pessimistic Lock) 사용**

- **재고 차감 쿼리**
  ```sql
  UPDATE products
  SET stock = stock - :quantity, version = version + 1
  WHERE id = :productId
    AND stock >= :quantity
    AND version = :currentVersion
  ```

### 2.3 재고 복원 조건
- 주문 취소 시
- 결제 실패 시
- 복원 시에도 동시성 제어 적용 (재고 증가)

### 2.4 재고 부족 처리
- 재고가 부족한 경우 주문 생성 자체를 거부
- 사용자에게 명확한 에러 메시지 반환
- 예: "상품 [노트북]의 재고가 부족합니다. (요청: 5개, 재고: 3개)"

## 3. 쿠폰 시스템 정책

### 3.1 쿠폰 발급 규칙
- **선착순 발급**
    - `issued_quantity < total_quantity` 조건 체크
    - 동시 발급 요청 시 동시성 제어 필요 (비관적 락)

- **중복 발급 방지**
    - 1인 1매 제한
    - `user_coupons` 테이블에서 (user_id, coupon_id) 조합으로 중복 체크
    - 이미 발급받은 경우 에러 반환

- **쿠폰 발급 시점**
    - 사용자 요청 시 즉시 발급
    - 발급 시 `coupons.issued_quantity` 증가
    - `user_coupons` 레코드 생성 (상태: AVAILABLE)

### 3.2 쿠폰 상태
```
AVAILABLE → 사용 가능
USED      → 사용 완료
EXPIRED   → 만료됨
```

### 3.3 쿠폰 사용 조건
- 쿠폰 상태가 AVAILABLE이어야 함
- 현재 시간이 `expires_at` 이전이어야 함
- 쿠폰 기간 내여야 함 (`coupons.start_date ~ end_date`)
- 한 주문에 하나의 쿠폰만 사용 가능

### 3.4 쿠폰 만료 정책
- 발급 시점부터 30일 후 자동 만료 (기본값)
- `expires_at`을 체크하여 만료 여부 판단
- 만료된 쿠폰 사용 시도 시 에러 반환

### 3.5 쿠폰 복원 규칙
- 결제 실패 시 USED → AVAILABLE로 복원
- 주문 취소 시 쿠폰 복원
- 쿠폰이 이미 만료된 경우 복원하지 않음 (EXPIRED 유지)

## 4. 금액 계산 정책

### 4.1 할인 금액 계산
```kotlin
// 주문 금액 계산 공식
totalAmount = sum(orderItem.unitPrice * orderItem.quantity)
discountAmount = totalAmount * (coupon.discountRate / 100)
finalAmount = totalAmount - discountAmount
```

### 4.2 반올림 규칙
- 모든 금액은 소수점 이하 **내림** 처리
- 예: 할인 금액이 12,345.67원인 경우 → 12,345원

### 4.3 할인율 제한
- 쿠폰 할인율: 10%, 20%, 30% 고정값
- 최대 할인 금액 제한 없음 (현재)
- 최소 주문 금액 제한 없음 (현재)

### 4.4 금액 검증
- 모든 금액은 0 이상이어야 함
- `finalAmount`는 `totalAmount - discountAmount`와 정확히 일치해야 함
- 사용자 잔액은 `finalAmount` 이상이어야 함

## 5. 동시성 제어 정책

### 5.1 재고 동시성
- **비관 락 사용**
- 재시도 정책: 최대 3회 재시도
- 재시도 간격: 100ms
- 3회 실패 시 주문 실패 처리

### 5.2 쿠폰 동시성
- **Redis 분산 락 + DB 비관적 락 + Transaction 조합**
  - Redis 분산 락: 멀티 서버 환경의 동시성 제어 및 DB 부하 감소
  - DB 비관적 락: 데이터 정합성 보장 (이중 보호)
  - Transaction: 데이터 원자성 보장
  - **트랜잭션 커밋 후 Redis 락 해제**: 다음 요청이 최신 데이터를 읽도록 보장 (핵심!)
- 선착순 발급 시 `issued_quantity` 증가를 원자적으로 처리
- 동시 발급 시도가 `total_quantity`를 초과하지 않도록 보장
- 락 획득 실패 시 빠른 실패 응답 (사용자 대기 시간 최소화)

### 5.3 트랜잭션 격리 수준
- 기본 격리 수준: `READ_COMMITTED`
- 필요 시 `REPEATABLE_READ` 사용 (쿠폰 발급, 재고 차감)

### 5.4 데드락 방지
- 리소스 접근 순서 통일
    1. 쿠폰 검증 및 사용
    2. 재고 차감
    3. 주문 생성
    4. 잔액 차감

## 6. 데이터 전송 정책 (Outbox Pattern)

### 6.1 Outbox 레코드 생성
- 주문이 PAID 상태로 변경될 때 `data_transmissions` 레코드 생성
- 주문과 동일한 트랜잭션 내에서 생성 (원자성 보장)
- 초기 상태: PENDING

### 6.2 재시도 정책
- **최대 재시도 횟수**: 3회
- **재시도 간격**: 지수 백오프
    - 1차: 1분 후
    - 2차: 5분 후
    - 3차: 15분 후

- **재시도 실행**
    - 배치 작업 또는 스케줄러로 PENDING/FAILED 상태 레코드 조회
    - 외부 시스템으로 데이터 전송 시도
    - 성공 시: status = SUCCESS, sent_at 기록
    - 실패 시: attempts 증가, status = FAILED

### 6.3 최종 실패 처리
- 3회 재시도 후에도 실패 시 상태를 FAILED로 유지
- 알림 발송 (관리자 이메일, 슬랙 등)
- 수동 개입 필요

### 6.4 중복 전송 방지
- `order_id`로 중복 체크
- 이미 SUCCESS 상태인 레코드는 재전송하지 않음
- 외부 시스템에서 멱등성 보장 필요 (order_id 기반)

## 7. 에러 처리 정책

### 7.1 비즈니스 예외
- 명확한 에러 메시지 제공
- HTTP 상태 코드 적절히 사용
    - 400: 잘못된 요청 (재고 부족, 쿠폰 중복 등)
    - 404: 리소스 없음 (상품, 쿠폰 미존재)
    - 409: 동시성 충돌 (비관적 락 실패)
    - 500: 서버 내부 오류

### 7.2 로깅
- 모든 비즈니스 예외는 WARNING 레벨로 로깅
- 시스템 오류는 ERROR 레벨로 로깅
- 주요 비즈니스 이벤트는 INFO 레벨로 로깅
    - 주문 생성, 결제 완료, 쿠폰 발급 등

## 8. 검증 규칙

### 8.1 주문 생성 시 검증 순서
1. 상품 존재 여부 확인
2. 재고 충분 여부 확인
3. 쿠폰 유효성 확인 (사용하는 경우)
4. 금액 계산 정확성 검증
5. 사용자 잔액 충분 여부 확인

### 8.2 데이터 유효성
- 상품 가격: 0 이상
- 주문 수량: 1 이상
- 재고: 0 이상
- 쿠폰 할인율: 1~100 사이

## 9. 성능 요구사항

### 9.1 응답 시간
- 주문 생성: 1초 이내
- 결제 처리: 2초 이내
- 쿠폰 발급: 500ms 이내

### 9.2 동시 처리
- 동일 상품에 대한 동시 주문: 최소 100 TPS 처리
- 동일 쿠폰에 대한 동시 발급: 최소 50 TPS 처리

---

## 구현 시 주의사항

1. **트랜잭션 경계 명확히**
    - 주문 생성, 결제, 보상 트랜잭션은 명확히 분리
    - 각 단계에서 롤백 조건 명확히 정의

2. **멱등성 보장**
    - 동일한 요청이 여러 번 들어와도 결과가 동일해야 함
    - 주문 ID, 쿠폰 발급 이력 등으로 중복 체크

3. **테스트 커버리지**
    - 동시성 시나리오 테스트 필수
    - 재고 부족, 쿠폰 만료 등 예외 케이스 테스트
    - 보상 트랜잭션 정상 동작 검증

## 이커머스 핵심 기능
1. 상품 관리
    - 상품 정보 조회 (가격, 재고)
    - 재고 실시간 확인
    - 인기 상품 통계 (최근 3일, Top 5)

2. 주문/결제 시스템
    - 장바구니 기능
    - 재고 확인 및 차감
    - 잔액 기반 결제
    - 쿠폰 할인 적용

3. 쿠폰 시스템
    - 선착순 발급 (한정 수량)
    - 쿠폰 유효성 검증
    - 사용 이력 관리

4. 데이터 연동
    - 주문 데이터 외부 전송
    - 실패 시에도 주문은 정상 처리

5. 배송 시스템
    - 주문 시 배송 준비중 상태의 배송 생성
    - 실패 시 생성 X