# K6 ë¶€í•˜ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸

API ê¸°ë°˜ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ìƒì„±í•˜ê³  ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•˜ëŠ” K6 ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.

## ğŸ¯ í…ŒìŠ¤íŠ¸ ëª©ì 

**ë‘ í™˜ê²½ì˜ ì„±ëŠ¥ì„ ë¹„êµ**í•˜ì—¬ ì¸í”„ë¼ ê°œì„  íš¨ê³¼ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤:

| í™˜ê²½                | ì„¤ëª…                                      | í”„ë¡œíŒŒì¼    |
| ------------------- | ----------------------------------------- | ----------- |
| **ë¶€í•˜í…ŒìŠ¤íŠ¸ í™˜ê²½** | ìˆœìˆ˜ DBë§Œ ì‚¬ìš© (ë¹„ê´€ì  ë½, DB ì§‘ê³„)       | `load-test` |
| **ìš´ì˜ í™˜ê²½**       | Redis + Kafka ì‚¬ìš© (ë¶„ì‚°ë½, ìºì‹œ, ë¹„ë™ê¸°) | `default`   |

## ğŸ“ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
k6/
â”œâ”€â”€ scenarios/
â”‚   â”œâ”€â”€ product-ranking.js   # ì¸ê¸° ìƒí’ˆ ì¡°íšŒ í…ŒìŠ¤íŠ¸
â”‚   â”œâ”€â”€ coupon-issue.js      # ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ í…ŒìŠ¤íŠ¸
â”‚   â””â”€â”€ order-payment.js     # ì£¼ë¬¸ ë° ê²°ì œ í†µí•© í…ŒìŠ¤íŠ¸
â”œâ”€â”€ results/                 # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì €ì¥ ë””ë ‰í† ë¦¬
â”‚   â”œâ”€â”€ load-test/           # ë¶€í•˜í…ŒìŠ¤íŠ¸ í™˜ê²½ ê²°ê³¼
â”‚   â””â”€â”€ production/          # ìš´ì˜ í™˜ê²½ ê²°ê³¼
â”œâ”€â”€ run-all.js               # ì „ì²´ ì‹œë‚˜ë¦¬ì˜¤ ìˆœì°¨ ì‹¤í–‰
â”œâ”€â”€ run-load-test.sh         # ë¶€í•˜í…ŒìŠ¤íŠ¸ í™˜ê²½ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ run-production.sh        # ìš´ì˜ í™˜ê²½ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
â””â”€â”€ README.md                # ì´ íŒŒì¼
```

## ğŸ¯ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ì¸ê¸° ìƒí’ˆ ì¡°íšŒ (product-ranking.js)

| í™˜ê²½       | êµ¬í˜„ ë°©ì‹                             |
| ---------- | ------------------------------------- |
| ë¶€í•˜í…ŒìŠ¤íŠ¸ | DB ì§‘ê³„ ì¿¼ë¦¬ (`GROUP BY`, `ORDER BY`) |
| ìš´ì˜       | Redis Sorted Set ê¸°ë°˜ ì‹¤ì‹œê°„ ë­í‚¹     |

-   **VU (Virtual Users)**: 50ëª…
-   **Duration**: 30ì´ˆ
-   **í”Œë¡œìš°**:
    1. setupì—ì„œ 50ëª…ì˜ ì‚¬ìš©ì ìƒì„± (API í˜¸ì¶œ)
    2. ìƒí’ˆ ëª©ë¡ ì¡°íšŒ
    3. ëœë¤ ìƒí’ˆ ì£¼ë¬¸ â†’ ê²°ì œ
    4. ì¸ê¸° ìƒí’ˆ Top ì¡°íšŒ

---

### 2. ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ (coupon-issue.js)

| í™˜ê²½       | ë™ì‹œì„± ì œì–´                            |
| ---------- | -------------------------------------- |
| ë¶€í•˜í…ŒìŠ¤íŠ¸ | ë¹„ê´€ì  ë½ (Pessimistic Lock, DB Level) |
| ìš´ì˜       | Redis ë¶„ì‚°ë½ (Distributed Lock)        |

-   **VU**: 0 â†’ 100ëª… (10ì´ˆì— ê±¸ì³ ì¦ê°€) â†’ 30ì´ˆ ìœ ì§€
-   **í”Œë¡œìš°**:
    1. setupì—ì„œ 100ëª…ì˜ ì‚¬ìš©ì ìƒì„± (API í˜¸ì¶œ)
    2. ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í° ëª©ë¡ ì¡°íšŒ
    3. 100ëª…ì´ ë™ì‹œì— ì¿ í° ë°œê¸‰ ìš”ì²­

---

### 3. ì£¼ë¬¸ ë° ê²°ì œ (order-payment.js)

| í™˜ê²½       | ì²˜ë¦¬ ë°©ì‹                     |
| ---------- | ----------------------------- |
| ë¶€í•˜í…ŒìŠ¤íŠ¸ | ë™ê¸° íŠ¸ëœì­ì…˜ ì²˜ë¦¬            |
| ìš´ì˜       | Kafka ê¸°ë°˜ ë¹„ë™ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬ |

-   **VU**: 100ëª…
-   **Duration**: 30ì´ˆ
-   **í”Œë¡œìš°**:
    1. setupì—ì„œ 100ëª…ì˜ ì‚¬ìš©ì ìƒì„± (API í˜¸ì¶œ)
    2. ìƒí’ˆ ëª©ë¡ ì¡°íšŒ
    3. ì£¼ë¬¸ ìƒì„± â†’ ê²°ì œ ì²˜ë¦¬ í†µí•© í”Œë¡œìš°

---

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### ì‚¬ì „ ì¤€ë¹„

1. **K6 ì„¤ì¹˜**

```bash
# macOS
brew install k6

# Windows (Chocolatey)
choco install k6

# Linux
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6
```

2. **í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„**

> âš ï¸ **ì¤‘ìš”**: ìƒí’ˆê³¼ ì¿ í°ì€ ë¯¸ë¦¬ DBì— ìƒì„±ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
> ì‚¬ìš©ìëŠ” ê° í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ì˜ `setup()`ì—ì„œ APIë¥¼ í†µí•´ ìë™ ìƒì„±ë©ë‹ˆë‹¤.

---

## ğŸ”„ í™˜ê²½ë³„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰

### 1ï¸âƒ£ ë¶€í•˜í…ŒìŠ¤íŠ¸ í™˜ê²½ (ìˆœìˆ˜ DB)

Redis, Kafka ì—†ì´ ìˆœìˆ˜ DBë§Œ ì‚¬ìš©í•˜ëŠ” í™˜ê²½ì…ë‹ˆë‹¤.

```bash
# 1. MySQLë§Œ ì‹¤í–‰
docker-compose up -d mysql

# 2. ë¶€í•˜í…ŒìŠ¤íŠ¸ í”„ë¡œíŒŒì¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
SPRING_PROFILES_ACTIVE=load-test ./gradlew bootRun

# 3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
chmod +x k6/run-load-test.sh
./k6/run-load-test.sh              # ì „ì²´ í…ŒìŠ¤íŠ¸
./k6/run-load-test.sh ranking      # ì¸ê¸° ìƒí’ˆë§Œ
./k6/run-load-test.sh coupon       # ì¿ í°ë§Œ
./k6/run-load-test.sh order-payment # ì£¼ë¬¸/ê²°ì œë§Œ
```

### 2ï¸âƒ£ ìš´ì˜ í™˜ê²½ (Redis + Kafka)

Redis, Kafkaë¥¼ í™œìš©í•œ ê°œì„ ëœ ì•„í‚¤í…ì²˜ í™˜ê²½ì…ë‹ˆë‹¤.

```bash
# 1. ëª¨ë“  ì˜ì¡´ì„± ì‹¤í–‰
docker-compose up -d

# 2. ê¸°ë³¸ í”„ë¡œíŒŒì¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
./gradlew bootRun

# 3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
chmod +x k6/run-production.sh
./k6/run-production.sh              # ì „ì²´ í…ŒìŠ¤íŠ¸
./k6/run-production.sh ranking      # ì¸ê¸° ìƒí’ˆë§Œ
./k6/run-production.sh coupon       # ì¿ í°ë§Œ
./k6/run-production.sh order-payment # ì£¼ë¬¸/ê²°ì œë§Œ
```

---

### ìˆ˜ë™ ì‹¤í–‰ (í™˜ê²½ ë³€ìˆ˜ ì§€ì •)

```bash
# ë¶€í•˜í…ŒìŠ¤íŠ¸ í™˜ê²½
PROFILE=load-test k6 run k6/run-all.js

# ìš´ì˜ í™˜ê²½
PROFILE=production k6 run k6/run-all.js
```

---

### ì „ì²´ ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰

ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤ (ì´ ì•½ 2.5ë¶„ ì†Œìš”).

```bash
k6 run k6/run-all.js
```

**ì‹¤í–‰ ìˆœì„œ**:

1. ì¸ê¸° ìƒí’ˆ ì¡°íšŒ (0-40ì´ˆ)
2. ì¿ í° ë°œê¸‰ (45-105ì´ˆ)
3. ì£¼ë¬¸ ë° ê²°ì œ (110-150ì´ˆ)

---

## âš™ï¸ í™˜ê²½ ë³€ìˆ˜

BASE_URLì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
# ê¸°ë³¸ê°’: http://localhost:8080/api
k6 run k6/scenarios/product-ranking.js

# ì»¤ìŠ¤í…€ URL
BASE_URL=http://192.168.1.100:8080/api k6 run k6/scenarios/product-ranking.js
```

---

## ğŸ“Š ê²°ê³¼ ë¶„ì„

### K6 ì¶œë ¥ ì§€í‘œ ì˜ˆì‹œ

```
     âœ“ status is 200
     âœ“ response time < 2000ms
     âœ“ has rankings

     checks.........................: 100.00% âœ“ 3000      âœ— 0
     data_received..................: 1.5 MB  50 kB/s
     data_sent......................: 300 kB  10 kB/s
     http_req_duration..............: avg=150ms    min=50ms med=130ms max=800ms p(90)=250ms p(95)=400ms
     http_req_failed................: 0.00%   âœ“ 0         âœ— 1000
     http_reqs......................: 1000    33.33/s
     iterations.....................: 1000    33.33/s
     vus............................: 100     min=100     max=100
```

### ì£¼ìš” ì§€í‘œ ì„¤ëª…

| ì§€í‘œ                | ì„¤ëª…                                    |
| ------------------- | --------------------------------------- |
| `http_req_duration` | HTTP ìš”ì²­ ì´ ì‹œê°„ (ì „ì†¡ + ëŒ€ê¸° + ìˆ˜ì‹ )  |
| `http_req_waiting`  | ì„œë²„ ì²˜ë¦¬ ì‹œê°„ (ì‘ë‹µ ëŒ€ê¸° ì‹œê°„)         |
| `http_reqs`         | ì´ ìš”ì²­ ìˆ˜ ë° RPS (Requests Per Second) |
| `http_req_failed`   | ì‹¤íŒ¨í•œ ìš”ì²­ ë¹„ìœ¨                        |
| `p(95), p(99)`      | 95%, 99% ë°±ë¶„ìœ„ìˆ˜ ì‘ë‹µ ì‹œê°„             |
| `checks`            | ê²€ì¦ í†µê³¼ìœ¨                             |

---

## ğŸ” ë¬¸ì œ í•´ê²°

### 1. ì—°ê²° ê±°ë¶€ (Connection Refused)

```
WARN[0001] Request Failed error="Get \"http://localhost:8080/api/...\": dial tcp 127.0.0.1:8080: connect: connection refused"
```

**í•´ê²°**: ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.

```bash
curl http://localhost:8080/api/products
```

---

### 2. ìƒí’ˆì´ ì—†ë‹¤ëŠ” ì—ëŸ¬

```
Error: ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ìƒí’ˆì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.
```

**í•´ê²°**: ìƒí’ˆì„ DBì— ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”. (í˜„ì¬ ìƒí’ˆ ìƒì„± APIê°€ ì—†ìœ¼ë¯€ë¡œ DBì—ì„œ ì§ì ‘ ìƒì„±)

---

### 3. ì¿ í°ì´ ì—†ë‹¤ëŠ” ì—ëŸ¬

```
Error: ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤. ì¿ í°ì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.
```

**í•´ê²°**: ì¿ í°ì„ DBì— ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”. (í˜„ì¬ ì¿ í° ìƒì„± APIê°€ ì—†ìœ¼ë¯€ë¡œ DBì—ì„œ ì§ì ‘ ìƒì„±)

---

### 4. ë†’ì€ ì‹¤íŒ¨ìœ¨

**ì›ì¸ (ì •ìƒì ì¸ ì‹¤íŒ¨)**:

-   ì¬ê³  ë¶€ì¡±
-   ì¿ í° í’ˆì ˆ
-   ì”ì•¡ ë¶€ì¡±
-   ì¤‘ë³µ ì¿ í° ë°œê¸‰ ì‹œë„

**í™•ì¸**: ë¡œê·¸ì—ì„œ ì‹¤íŒ¨ ì‚¬ìœ ë¥¼ í™•ì¸í•˜ì„¸ìš”.

---

## ğŸ¯ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìš”êµ¬ì‚¬í•­

ê° ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰ ì „ í•„ìš”í•œ ë°ì´í„°:

| ì‹œë‚˜ë¦¬ì˜¤       | ì‚¬ìš©ì            | ìƒí’ˆ          | ì¿ í°          |
| -------------- | ----------------- | ------------- | ------------- |
| ì¸ê¸° ìƒí’ˆ ì¡°íšŒ | ìë™ ìƒì„± (50ëª…)  | ìµœì†Œ 1ê°œ í•„ìš” | -             |
| ì¿ í° ë°œê¸‰      | ìë™ ìƒì„± (100ëª…) | -             | ìµœì†Œ 1ê°œ í•„ìš” |
| ì£¼ë¬¸ ë° ê²°ì œ   | ìë™ ìƒì„± (100ëª…) | ìµœì†Œ 1ê°œ í•„ìš” | -             |

---

## ğŸ“Š ì„±ëŠ¥ ë¹„êµ ë³´ê³ ì„œ

í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ë‘ í™˜ê²½ì˜ ê²°ê³¼ë¥¼ ë¹„êµí•˜ì—¬ ê°œì„  íš¨ê³¼ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.

### ë³´ê³ ì„œ ì‘ì„±

1. ë‘ í™˜ê²½ì—ì„œ ê°ê° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
2. `k6/results/` ë””ë ‰í† ë¦¬ì˜ ê²°ê³¼ íŒŒì¼ í™•ì¸
3. [ì„±ëŠ¥ ë¹„êµ ë³´ê³ ì„œ í…œí”Œë¦¿](../docs/LOAD_TEST_COMPARISON_REPORT.md)ì— ê²°ê³¼ ê¸°ì…

### ê²°ê³¼ íŒŒì¼ ìœ„ì¹˜

```
k6/results/
â”œâ”€â”€ load-test/                     # ë¶€í•˜í…ŒìŠ¤íŠ¸ í™˜ê²½ ê²°ê³¼
â”‚   â”œâ”€â”€ run-all_YYYYMMDD_HHMMSS.json
â”‚   â””â”€â”€ run-all_YYYYMMDD_HHMMSS_summary.json
â””â”€â”€ production/                    # ìš´ì˜ í™˜ê²½ ê²°ê³¼
    â”œâ”€â”€ run-all_YYYYMMDD_HHMMSS.json
    â””â”€â”€ run-all_YYYYMMDD_HHMMSS_summary.json
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

-   [K6 ê³µì‹ ë¬¸ì„œ](https://k6.io/docs/)
-   [K6 Thresholds](https://k6.io/docs/using-k6/thresholds/)
-   [K6 Scenarios](https://k6.io/docs/using-k6/scenarios/)
-   [ì„±ëŠ¥ ë¹„êµ ë³´ê³ ì„œ í…œí”Œë¦¿](../docs/LOAD_TEST_COMPARISON_REPORT.md)
